<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Part 2 - Building the Services</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.b25df986.css" as="style"><link rel="preload" href="/assets/js/app.de94086e.js" as="script"><link rel="preload" href="/assets/js/2.0005fb99.js" as="script"><link rel="preload" href="/assets/js/8.d8750b3a.js" as="script"><link rel="prefetch" href="/assets/js/10.1b1bac62.js"><link rel="prefetch" href="/assets/js/11.d5ccb284.js"><link rel="prefetch" href="/assets/js/12.041ebee5.js"><link rel="prefetch" href="/assets/js/13.32117bf8.js"><link rel="prefetch" href="/assets/js/14.846c76b5.js"><link rel="prefetch" href="/assets/js/15.50f29b11.js"><link rel="prefetch" href="/assets/js/16.1209f32e.js"><link rel="prefetch" href="/assets/js/17.05965361.js"><link rel="prefetch" href="/assets/js/18.0deb6c5a.js"><link rel="prefetch" href="/assets/js/19.c0b807a9.js"><link rel="prefetch" href="/assets/js/20.eca6b9de.js"><link rel="prefetch" href="/assets/js/21.83db0212.js"><link rel="prefetch" href="/assets/js/22.8c84fb58.js"><link rel="prefetch" href="/assets/js/23.e8ce4875.js"><link rel="prefetch" href="/assets/js/24.fd7b0084.js"><link rel="prefetch" href="/assets/js/25.cdf82bd3.js"><link rel="prefetch" href="/assets/js/26.f554011d.js"><link rel="prefetch" href="/assets/js/27.df20cf08.js"><link rel="prefetch" href="/assets/js/28.2318a9ac.js"><link rel="prefetch" href="/assets/js/29.628dd84b.js"><link rel="prefetch" href="/assets/js/3.1a98c051.js"><link rel="prefetch" href="/assets/js/30.47ff2eac.js"><link rel="prefetch" href="/assets/js/31.eb71eabe.js"><link rel="prefetch" href="/assets/js/32.c74d3c6a.js"><link rel="prefetch" href="/assets/js/33.19a01216.js"><link rel="prefetch" href="/assets/js/34.aed43787.js"><link rel="prefetch" href="/assets/js/35.b40f612a.js"><link rel="prefetch" href="/assets/js/36.ae14410d.js"><link rel="prefetch" href="/assets/js/37.74d7c586.js"><link rel="prefetch" href="/assets/js/38.54528dd5.js"><link rel="prefetch" href="/assets/js/39.e8c514e8.js"><link rel="prefetch" href="/assets/js/4.3083dbc5.js"><link rel="prefetch" href="/assets/js/40.5c97b972.js"><link rel="prefetch" href="/assets/js/41.7a1cf8ba.js"><link rel="prefetch" href="/assets/js/42.f449294e.js"><link rel="prefetch" href="/assets/js/43.432c7e84.js"><link rel="prefetch" href="/assets/js/44.d56e3403.js"><link rel="prefetch" href="/assets/js/45.c6081de4.js"><link rel="prefetch" href="/assets/js/5.28112fa8.js"><link rel="prefetch" href="/assets/js/6.50910651.js"><link rel="prefetch" href="/assets/js/7.90248bbe.js"><link rel="prefetch" href="/assets/js/9.ab982ebf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b25df986.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="part-2-services-building-the-crud-data-layers"><a href="#part-2-services-building-the-crud-data-layers" class="header-anchor">#</a> Part 2 - Services - Building the CRUD Data Layers</h1> <p>This the second article in a series on Building Blazor Database Applications.  It describes how to bouilerplate the data and business logic layers into generic library code that makes deploying application specific data services simple.  It is a total rewrite from earlier releases.</p> <p>The articles in the series are:</p> <ol><li>Project Structure and Framework.</li> <li>Services - Building the CRUD Data Layers.</li> <li>View Components - CRUD Edit and View Operations in the UI.</li> <li>UI Components - Building HTML/CSS Controls.</li> <li>View Components - CRUD List Operations in the UI.</li></ol> <h2 id="repository-and-database"><a href="#repository-and-database" class="header-anchor">#</a> Repository and Database</h2> <p>The repository has moved to <a href="https://github.com/ShaunCurtis/CEC.Database" target="_blank" rel="noopener noreferrer">CEC.Database Repository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.  You can use it as a template for developing your own applications.  Previous repositories are obselete and will be removed.</p> <p>There's a SQL script in /SQL in the repository for building the database.  The application can use either a real SQL database or an in-memory SQLite database.</p> <p><a href="https://cec-blazor-database.azurewebsites.net/" target="_blank" rel="noopener noreferrer">You can see the Server and WASM versions of the project running here on the same site<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="objective"><a href="#objective" class="header-anchor">#</a> Objective</h2> <p>Let's look at our goal before diving into specifics: build library code so declaring a standard UI controller service is as simple as this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastControllerService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">FactoryControllerService<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">WeatherForecastControllerService</span><span class="token punctuation">(</span><span class="token class-name">IFactoryDataService</span> factoryDataService<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>factoryDataService<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>And declaring a database <code>DbContext</code> that looks like:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LocalWeatherDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">LocalWeatherDbContext</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptions<span class="token punctuation">&lt;</span>LocalWeatherDbContext<span class="token punctuation">&gt;</span></span> options<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
        <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment">// A DbSet per database entity</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> WeatherForecast <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre></div><p>Our process for adding a new database entity is:</p> <ol><li>Add the necessary table to the database.</li> <li>Define a Dataclass.</li> <li>Define a <code>DbSet</code> in the <code>DbContext</code>.</li> <li>Define a <code>public class nnnnnnControllerService</code> Service and register it with the Services container.</li></ol> <p>There will be complications with certain entities, but that doesn't invalidate the approach - 80%+ of the code in the library.</p> <h2 id="services"><a href="#services" class="header-anchor">#</a> Services</h2> <p>Blazor is built on DI [Dependency Injection] and IOC [Inversion of Control] principles.  If you're unfamiliar with these concepts, do a little <a href="https://www.codeproject.com/Articles/5274732/Dependency-Injection-and-IoC-Containers-in-Csharp" target="_blank" rel="noopener noreferrer">backgound reading<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> before diving into Blazor.  It'll save you time in the long run!</p> <p>Blazor Singleton and Transient services are relatively straight forward.  You can read more about them in the <a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/fundamentals/dependency-injection" target="_blank" rel="noopener noreferrer">Microsoft Documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.  Scoped are a little more complicated.</p> <ol><li>A scoped service object exists for the lifetime of a client application session - note client and not server.  Any application resets, such as F5 or navigation away from the application, resets all scoped services.  A duplicated tab in a browser creates a new application, and a new set of scoped services.</li> <li>A scoped service can be further scoped to an single object in code.  The <code>OwningComponentBase</code> component class has functionality to restrict the life of a scoped service to the lifetime of the component.</li></ol> <p><code>Services</code> is the Blazor IOC [Inversion of Control] container. Service instances are declared:</p> <ol><li>In Blazor Server in <code>Startup.cs</code> in <code>ConfigureServices</code></li> <li>In Blazor WASM in <code>Program.cs</code>.</li></ol> <p>The solution uses a Service Collection extension methods such as <code>AddApplicationServices</code> to keep all the application specific services under one roof.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// Blazor.Database.Web/startup.cs</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddRazorPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddServerSideBlazor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// the local application Services defined in ServiceCollectionExtensions.cs</span>
    <span class="token comment">// services.AddApplicationServices(this.Configuration);</span>
    services<span class="token punctuation">.</span><span class="token function">AddInMemoryApplicationServices</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Extensions are declared as a static extension methods in a static class.  The two methods are shown below.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">//Blazor.Database.Web/Extensions/ServiceCollectionExtensions.cs</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServiceCollectionExtensions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">AddApplicationServices</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Local DB Setup</span>
        <span class="token class-name"><span class="token keyword">var</span></span> dbContext <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;Configuration:DBContext&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContextFactory</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>LocalWeatherDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span> options<span class="token punctuation">.</span><span class="token function">UseSqlServer</span><span class="token punctuation">(</span>dbContext<span class="token punctuation">)</span><span class="token punctuation">,</span> ServiceLifetime<span class="token punctuation">.</span>Singleton<span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFactoryDataService<span class="token punctuation">,</span> LocalDatabaseDataService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecastControllerService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> services<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">AddInMemoryApplicationServices</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// In Memory DB Setup</span>
        <span class="token class-name"><span class="token keyword">var</span></span> memdbContext <span class="token operator">=</span> <span class="token string">&quot;Data Source=:memory:&quot;</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContextFactory</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>InMemoryWeatherDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span> options<span class="token punctuation">.</span><span class="token function">UseSqlite</span><span class="token punctuation">(</span>memdbContext<span class="token punctuation">)</span><span class="token punctuation">,</span> ServiceLifetime<span class="token punctuation">.</span>Singleton<span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFactoryDataService<span class="token punctuation">,</span> TestDatabaseDataService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecastControllerService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> services<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In the WASM project in <code>program.cs</code>:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// program.cs</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token range operator">..</span><span class="token range operator">..</span><span class="token punctuation">.</span>
    <span class="token comment">// Added here as we don't have access to builder in AddApplicationServices</span>
    builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddScoped</span><span class="token punctuation">(</span>sp <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpClient</span> <span class="token punctuation">{</span> BaseAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>HostEnvironment<span class="token punctuation">.</span>BaseAddress<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// the Services for the Application</span>
    builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddWASMApplicationServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token range operator">..</span><span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// ServiceCollectionExtensions.cs</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">AddWASMApplicationServices</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFactoryDataService<span class="token punctuation">,</span> FactoryWASMDataService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecastControllerService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> services<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Points:</p> <ol><li>There's an <code>IServiceCollection</code> extension method for each project/library to encapsulate the specific services needed for the project.</li> <li>Only the data layer service is different.  The Server version, used by both the Blazor Server and the WASM API Server, interfaces with the database and Entity Framework.  It's scoped as a Singleton.</li> <li>Everything is async, using a <code>DbContextFactory</code> and manage <code>DbContext</code> instances as they are used.  The WASM Client version uses <code>HttpClient</code> (which is a scoped service) to make calls to the API and is therefore scoped.</li> <li>the <code>FactoryDataService</code> implementing <code>IFactoryDataService</code> processes all data requests through generics.  <code>TRecord</code> defines which dataset is retrieved and returned.   The factory services boilerplate all core data service code.</li> <li>There's both a real SQL Database and an in-memory SQLite <code>DbContext</code>.</li></ol> <h3 id="generics"><a href="#generics" class="header-anchor">#</a> Generics</h3> <p>The factory library code relies heavily on Generics.  Two generic entities are defined:</p> <ol><li><code>TRecord</code> represents a model record class.  It must be a class, implement <code>IDbRecord</code> and define an empty <code>new()</code>.  <code>TRecord</code> is used at the method level.</li> <li><code>TDbContext</code> is the database context. It must inherit from the <code>DbContext</code> class.</li></ol> <p>Class declarations look like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">//Blazor.SPA/Services/FactoryDataService.cs</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">FactoryDataService<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IFactoryDataService<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span></span>
    <span class="token keyword">where</span> <span class="token class-name">TContext</span> <span class="token punctuation">:</span> DbContext
<span class="token range operator">..</span><span class="token range operator">..</span><span class="token range operator">..</span>
    <span class="token comment">// example method template  </span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="data-access"><a href="#data-access" class="header-anchor">#</a> Data Access</h2> <p>Before diving into the detail, let's look at the main CRUDL methods we need to implement:</p> <ol><li><em>GetRecordList</em> - get a List of records in the dataset.  This can be paged and sorted.</li> <li><em>GetRecord</em> - get a single record by ID</li> <li><em>CreateRecord</em> - Create a new record</li> <li><em>UpdateRecord</em> - Update the record based on ID</li> <li><em>DeleteRecord</em> - Delete the record based on ID</li></ol> <p>Keep these in mind as we work through this article.</p> <h3 id="dbtaskresult"><a href="#dbtaskresult" class="header-anchor">#</a> DbTaskResult</h3> <p>Data layer CUD operations return a <code>DbTaskResult</code> object.  Most of the properties are self-evident.  It's designed to be consumed by the UI to build CSS Framework entities such as Alerts and Toasts.  <code>NewID</code> returns the new ID from a <em>Create</em> operation.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DbTaskResult</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Message <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">&quot;New Object Message&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">MessageType</span> Type <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> MessageType<span class="token punctuation">.</span>None<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsOK <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> NewID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="data-classes"><a href="#data-classes" class="header-anchor">#</a> Data Classes</h2> <p>Data classes implement <code>IDbRecord</code>.</p> <ol><li><code>ID</code> is the standard database Identity field.  normally an <code>int</code>.</li> <li><code>GUID</code> is a unique identifier for this copy of the record.</li> <li><code>DisplayName</code> provides a generic name for the record.  We can use this in titles and other UI components.</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDbRecord<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> 
        <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> GUID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> DisplayName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="weatherforecast"><a href="#weatherforecast" class="header-anchor">#</a> WeatherForecast</h3> <p>Here's the dataclass for a WeatherForecast data entity.</p> <p>Points:</p> <ol><li>Entity Framework attributes used for property labelling.</li> <li>Implementation of <code>IDbRecord</code>.</li> <li>Implementation of <code>IValidation</code>.  We'll cover custom validation in the third article.</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecast</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IValidation</span><span class="token punctuation">,</span> <span class="token class-name">IDbRecord<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Key</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> Date <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> TemperatureC <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NotMapped</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> TemperatureF <span class="token operator">=&gt;</span> <span class="token number">32</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>TemperatureC <span class="token operator">/</span> <span class="token number">0.5556</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Summary <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NotMapped</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> GUID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> init<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NotMapped</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> DisplayName <span class="token operator">=&gt;</span> <span class="token interpolation-string"><span class="token string">$&quot;Weather Forecast for </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token keyword">this</span><span class="token punctuation">.</span>Date<span class="token punctuation">.</span><span class="token function">ToShortDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string"> &quot;</span></span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">Validate</span><span class="token punctuation">(</span><span class="token class-name">ValidationMessageStore</span> validationMessageStore<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> fieldname<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> model <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            model <span class="token operator">=</span> model <span class="token operator">??</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">bool</span></span> trip <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>Summary<span class="token punctuation">.</span><span class="token function">Validation</span><span class="token punctuation">(</span><span class="token string">&quot;Summary&quot;</span><span class="token punctuation">,</span> model<span class="token punctuation">,</span> validationMessageStore<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">LongerThan</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;Your description needs to be a little longer! 3 letters minimum&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> trip<span class="token punctuation">,</span> fieldname<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>Date<span class="token punctuation">.</span><span class="token function">Validation</span><span class="token punctuation">(</span><span class="token string">&quot;Date&quot;</span><span class="token punctuation">,</span> model<span class="token punctuation">,</span> validationMessageStore<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">NotDefault</span><span class="token punctuation">(</span><span class="token string">&quot;You must select a date&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">LessThan</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddMonths</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;Date can only be up to 1 month ahead&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> trip<span class="token punctuation">,</span> fieldname<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>TemperatureC<span class="token punctuation">.</span><span class="token function">Validation</span><span class="token punctuation">(</span><span class="token string">&quot;TemperatureC&quot;</span><span class="token punctuation">,</span> model<span class="token punctuation">,</span> validationMessageStore<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">LessThan</span><span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token string">&quot;The temperature must be less than 70C&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">GreaterThan</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token string">&quot;The temperature must be greater than -60C&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> trip<span class="token punctuation">,</span> fieldname<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token operator">!</span>trip<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><h2 id="the-entity-framework-tier"><a href="#the-entity-framework-tier" class="header-anchor">#</a> The Entity Framework Tier</h2> <p>The application implements two Entity Framework <code>DBContext</code> classes.</p> <h4 id="weatherforecastdbcontext"><a href="#weatherforecastdbcontext" class="header-anchor">#</a> WeatherForecastDBContext</h4> <p>The <code>DbContext</code> has a <code>DbSet</code> per record type.  Each <code>DbSet</code> is linked to a view in <code>OnModelCreating()</code>.  The WeatherForecast application has one record type.</p> <h4 id="localweatherdbcontext"><a href="#localweatherdbcontext" class="header-anchor">#</a> LocalWeatherDbContext</h4> <p>The class is very basic, creating a <code>DbSet</code> per dataclass.  The DBSet must be the same name as the dataclass.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LocalWeatherDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Guid</span> _id<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">LocalWeatherDbContext</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptions<span class="token punctuation">&lt;</span>LocalWeatherDbContext<span class="token punctuation">&gt;</span></span> options<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> _id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> WeatherForecast <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="inmemoryweatherdbcontext"><a href="#inmemoryweatherdbcontext" class="header-anchor">#</a> InMemoryWeatherDbContext</h4> <p>The in-memory version is a little more complicated, it needs to build and populate the database on the fly.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InMemoryWeatherDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Guid</span> _id<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">InMemoryWeatherDbContext</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptions<span class="token punctuation">&lt;</span>InMemoryWeatherDbContext<span class="token punctuation">&gt;</span></span> options<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">BuildInMemoryDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> WeatherForecast <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BuildInMemoryDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> conn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">GetDbConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            conn<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> cmd <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">CreateCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cmd<span class="token punctuation">.</span>CommandText <span class="token operator">=</span> <span class="token string">&quot;CREATE TABLE [WeatherForecast]([ID] INTEGER PRIMARY KEY AUTOINCREMENT, [Date] [smalldatetime] NOT NULL, [TemperatureC] [int] NOT NULL, [Summary] [varchar](255) NULL)&quot;</span><span class="token punctuation">;</span>
            cmd<span class="token punctuation">.</span><span class="token function">ExecuteNonQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> forecast <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>NewForecasts<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                cmd<span class="token punctuation">.</span>CommandText <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;INSERT INTO WeatherForecast([Date], [TemperatureC], [Summary]) VALUES('</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">forecast<span class="token punctuation">.</span>Date<span class="token punctuation">.</span><span class="token function">ToLongDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">', </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">forecast<span class="token punctuation">.</span>TemperatureC</span><span class="token punctuation">}</span></span><span class="token string">, '</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">forecast<span class="token punctuation">.</span>Summary</span><span class="token punctuation">}</span></span><span class="token string">')&quot;</span></span><span class="token punctuation">;</span>
                cmd<span class="token punctuation">.</span><span class="token function">ExecuteNonQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> Summaries <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;Freezing&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bracing&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Chilly&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Cool&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mild&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Warm&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Balmy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Hot&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Sweltering&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Scorching&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> NewForecasts
        <span class="token punctuation">{</span>
            <span class="token keyword">get</span>
            <span class="token punctuation">{</span>
                <span class="token punctuation">{</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">return</span> Enumerable<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>index <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WeatherForecast</span>
                    <span class="token punctuation">{</span>
                        <span class="token comment">//ID = index,</span>
                        Date <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        TemperatureC <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        Summary <span class="token operator">=</span> Summaries<span class="token punctuation">[</span>rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>Summaries<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">]</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

</code></pre></div><h4 id="dbcontextextensions"><a href="#dbcontextextensions" class="header-anchor">#</a> DbContextExtensions</h4> <p>We use generics, so we need a way to get the <code>DbSet</code> for the dataclass declared as <code>TRecord</code>.  This is implemented as a extension method on <code>DbContext</code>.  For this to work, each <code>DbSet</code> should have the same name as the dataclass. <code>dbSetName</code> provides backup if the names differ.</p> <p>The method uses reflection to find the <code>DbSet</code> for <code>TRecord</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">DbContext</span> context<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> dbSetName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> recname <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">;</span>
    <span class="token comment">// Get the property info object for the DbSet </span>
    <span class="token class-name"><span class="token keyword">var</span></span> pinfo <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span>dbSetName <span class="token operator">??</span> recname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DbSet<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> dbSet <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
    <span class="token comment">// Get the property DbSet</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        dbSet <span class="token operator">=</span> <span class="token punctuation">(</span>DbSet<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">)</span>pinfo<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">recname</span><span class="token punctuation">}</span></span><span class="token string"> does not have a matching DBset &quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>dbSet <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> dbSet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="ifactorydataservice"><a href="#ifactorydataservice" class="header-anchor">#</a> IFactoryDataService</h4> <p><code>IFactoryDataService</code> defines the base CRUDL methods DataServices must implement.  Data Services are defined in the Services container using the interface and consumed through the interface.  Note <code>TRecord</code> in each method and it's constraints.  There are two <code>GetRecordListAsync</code> methods.  One gets the whole dataset, the other uses a <code>PaginstorData</code> object to page and sort the dataset.  More on the <code>Paginator</code> in articles 5.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFactoryDataService</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">PaginatorData</span> paginatorData<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CreateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="factorydataservice"><a href="#factorydataservice" class="header-anchor">#</a> FactoryDataService</h4> <p><code>FactoryDataService</code> is abstract implementation of <code>IFactoryDataService</code>.  It provides default records, lists or <em>not implemented</em> <code>DBTaskResult</code> messages.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">FactoryDataService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IFactoryDataService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> ServiceID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IConfiguration</span> AppConfiguration <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">FactoryDataService</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>AppConfiguration <span class="token operator">=</span> configuration<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">PaginatorData</span> paginatorData<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> IsOK <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> Type <span class="token operator">=</span> MessageType<span class="token punctuation">.</span>NotImplemented<span class="token punctuation">,</span> Message <span class="token operator">=</span> <span class="token string">&quot;Method not implemented&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CreateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> IsOK <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> Type <span class="token operator">=</span> MessageType<span class="token punctuation">.</span>NotImplemented<span class="token punctuation">,</span> Message <span class="token operator">=</span> <span class="token string">&quot;Method not implemented&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> IsOK <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> Type <span class="token operator">=</span> MessageType<span class="token punctuation">.</span>NotImplemented<span class="token punctuation">,</span> Message <span class="token operator">=</span> <span class="token string">&quot;Method not implemented&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="factoryserverdataservice"><a href="#factoryserverdataservice" class="header-anchor">#</a> FactoryServerDataService</h4> <p>This is the concrete server-side implementation.  Each database operation is implemented using separate <code>DbContext</code> instances.  Note <code>GetDBSet</code> used to get the correct DBSet for <code>TRecord</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FactoryServerDataService<span class="token punctuation">&lt;</span>TDbContext<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">FactoryDataService</span></span> <span class="token keyword">where</span> <span class="token class-name">TDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IDbContextFactory<span class="token punctuation">&lt;</span>TDbContext<span class="token punctuation">&gt;</span></span> DBContext <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">FactoryServerDataService</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">IDbContextFactory<span class="token punctuation">&lt;</span>TDbContext<span class="token punctuation">&gt;</span></span> dbContext<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext <span class="token operator">=</span> dbContext<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext
            <span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">PaginatorData</span> paginatorData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> startpage <span class="token operator">=</span> paginatorData<span class="token punctuation">.</span>Page <span class="token operator">&lt;=</span> <span class="token number">1</span>
            <span class="token punctuation">?</span> <span class="token number">0</span>
            <span class="token punctuation">:</span> <span class="token punctuation">(</span>paginatorData<span class="token punctuation">.</span>Page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> paginatorData<span class="token punctuation">.</span>PageSize<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext
            <span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> x <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TRecord</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span>paginatorData<span class="token punctuation">.</span>SortColumn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> isSortable <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TRecord</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span>paginatorData<span class="token punctuation">.</span>SortColumn<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSortable<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> list <span class="token operator">=</span> <span class="token keyword">await</span> dbset
                <span class="token punctuation">.</span><span class="token function">OrderBy</span><span class="token punctuation">(</span>paginatorData<span class="token punctuation">.</span>SortDescending <span class="token punctuation">?</span> <span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">paginatorData<span class="token punctuation">.</span>SortColumn</span><span class="token punctuation">}</span></span><span class="token string"> descending&quot;</span></span> <span class="token punctuation">:</span> paginatorData<span class="token punctuation">.</span>SortColumn<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Skip</span><span class="token punctuation">(</span>startpage<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Take</span><span class="token punctuation">(</span>paginatorData<span class="token punctuation">.</span>PageSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> list<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> list <span class="token operator">=</span> <span class="token keyword">await</span> dbset
                <span class="token punctuation">.</span><span class="token function">Skip</span><span class="token punctuation">(</span>startpage<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Take</span><span class="token punctuation">(</span>paginatorData<span class="token punctuation">.</span>PageSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> list<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span>
            <span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">)</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span>ID <span class="token operator">==</span> id<span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CountAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> EntityState<span class="token punctuation">.</span>Modified<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">UpdateContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CreateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">UpdateContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> EntityState<span class="token punctuation">.</span>Deleted<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">UpdateContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token function">UpdateContext</span><span class="token punctuation">(</span><span class="token class-name">DbContext</span> context<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">?</span> DbTaskResult<span class="token punctuation">.</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> DbTaskResult<span class="token punctuation">.</span><span class="token function">NotOK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>FactoryWASMDataService</code> looks a little different.  It implements the interface, but uses <code>HttpClient</code> to get/post to the API on the server.</p> <p>The service map looks like this:</p> <p>UI Controller Service =&gt; WASMDataService =&gt; API Controller =&gt; ServerDataService =&gt; DBContext</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FactoryWASMDataService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">FactoryDataService</span><span class="token punctuation">,</span> <span class="token class-name">IFactoryDataService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token return-type class-name">HttpClient</span> HttpClient <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">FactoryWASMDataService</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">HttpClient</span> httpClient<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient <span class="token operator">=</span> httpClient<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token generic-method"><span class="token function">GetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">/list&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">PaginatorData</span> paginatorData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token function">PostAsJsonAsync</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token generic-method"><span class="token function">GetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">/listpaged&quot;</span></span><span class="token punctuation">,</span> paginatorData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token function">PostAsJsonAsync</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token generic-method"><span class="token function">GetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">/read&quot;</span></span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token generic-method"><span class="token function">GetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">/count&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">PostAsJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token generic-method"><span class="token function">GetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">/update&quot;</span></span><span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CreateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">PostAsJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token generic-method"><span class="token function">GetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">/create&quot;</span></span><span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">PostAsJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token generic-method"><span class="token function">GetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">/update&quot;</span></span><span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">GetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="api-controllers"><a href="#api-controllers" class="header-anchor">#</a> API Controllers</h4> <p>Controllers are implemented in the Web project, one per DataClass.</p> <p>The WeatherForecast Controller is shown below.  It basically passes requests through the <code>IFactoryService</code> interface to the <code>FactoryServerDataService</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token return-type class-name">IFactoryDataService</span> DataService <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>WeatherForecastController<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">WeatherForecastController</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>WeatherForecastController<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">,</span> <span class="token class-name">IFactoryDataService</span> dataService<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>DataService <span class="token operator">=</span> dataService<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/list&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/listpaged&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name">PaginatorData</span> data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span> <span class="token named-parameter punctuation">paginator</span><span class="token punctuation">:</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/count&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/get&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> <span class="token function">GetRec</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/read&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/update&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span><span class="token class-name">WeatherForecast</span> record<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/create&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span><span class="token class-name">WeatherForecast</span> record<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/delete&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token function">Delete</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name">WeatherForecast</span> record<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="factoryserverinmemorydataservice"><a href="#factoryserverinmemorydataservice" class="header-anchor">#</a> FactoryServerInMemoryDataService</h4> <p>For testing and demos there's another Server Data Service using the SQLite in-memory <code>DbContext</code>.</p> <p>The code is similar to <code>FactoryServerDataService</code>, but uses a single <code>DbContext</code> for all transactions.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FactoryServerInMemoryDataService<span class="token punctuation">&lt;</span>TDbContext<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">FactoryDataService</span><span class="token punctuation">,</span> <span class="token class-name">IFactoryDataService</span></span> <span class="token keyword">where</span> <span class="token class-name">TDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IDbContextFactory<span class="token punctuation">&lt;</span>TDbContext<span class="token punctuation">&gt;</span></span> DBContext <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">DbContext</span> _dbContext<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">FactoryServerInMemoryDataService</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">IDbContextFactory<span class="token punctuation">&lt;</span>TDbContext<span class="token punctuation">&gt;</span></span> dbContext<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext <span class="token operator">=</span> dbContext<span class="token punctuation">;</span>
        _dbContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> dbset<span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">PaginatorData</span> paginatorData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> startpage <span class="token operator">=</span> paginatorData<span class="token punctuation">.</span>Page <span class="token operator">&lt;=</span> <span class="token number">1</span>
            <span class="token punctuation">?</span> <span class="token number">0</span>
            <span class="token punctuation">:</span> <span class="token punctuation">(</span>paginatorData<span class="token punctuation">.</span>Page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> paginatorData<span class="token punctuation">.</span>PageSize<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> isSortable <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TRecord</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span>paginatorData<span class="token punctuation">.</span>SortColumn<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSortable<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> list <span class="token operator">=</span> <span class="token keyword">await</span> dbset
                <span class="token punctuation">.</span><span class="token function">OrderBy</span><span class="token punctuation">(</span>paginatorData<span class="token punctuation">.</span>SortDescending <span class="token punctuation">?</span> <span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">paginatorData<span class="token punctuation">.</span>SortColumn</span><span class="token punctuation">}</span></span><span class="token string"> descending&quot;</span></span> <span class="token punctuation">:</span> paginatorData<span class="token punctuation">.</span>SortColumn<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Skip</span><span class="token punctuation">(</span>startpage<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Take</span><span class="token punctuation">(</span>paginatorData<span class="token punctuation">.</span>PageSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> list<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> list <span class="token operator">=</span> <span class="token keyword">await</span> dbset
                <span class="token punctuation">.</span><span class="token function">Skip</span><span class="token punctuation">(</span>startpage<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Take</span><span class="token punctuation">(</span>paginatorData<span class="token punctuation">.</span>PageSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> list<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> dbset<span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">)</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span>ID <span class="token operator">==</span> id<span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> dbset<span class="token punctuation">.</span><span class="token function">CountAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _dbContext<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> EntityState<span class="token punctuation">.</span>Modified<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> x <span class="token operator">=</span> <span class="token keyword">await</span> _dbContext<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> IsOK <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> Type <span class="token operator">=</span> MessageType<span class="token punctuation">.</span>Success <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CreateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbset<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> x <span class="token operator">=</span> <span class="token keyword">await</span> _dbContext<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> IsOK <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> Type <span class="token operator">=</span> MessageType<span class="token punctuation">.</span>Success<span class="token punctuation">,</span> NewID <span class="token operator">=</span> record<span class="token punctuation">.</span>ID <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _dbContext<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> EntityState<span class="token punctuation">.</span>Deleted<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> x <span class="token operator">=</span> <span class="token keyword">await</span> _dbContext<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> IsOK <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> Type <span class="token operator">=</span> MessageType<span class="token punctuation">.</span>Success <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="controller-services"><a href="#controller-services" class="header-anchor">#</a> Controller Services</h3> <p>Controller Services are the interface between the Data Service and the UI.  They implement the logic needed to manage the dataclass they are responsible for.  While most of the code resides in <code>FactoryControllerService</code>, there's inevitiably some dataclass specific code.</p> <h4 id="ifactorycontrollerservice"><a href="#ifactorycontrollerservice" class="header-anchor">#</a> IFactoryControllerService</h4> <p><code>IFactoryControllerService</code> defines the common interface that the base forms code uses.</p> <p>Note:</p> <ol><li>Generic <code>TRecord</code>.</li> <li>Properties holding the current record and record list.</li> <li>Boolean logic properties to simplify state management.</li> <li>Events for record and list changes.</li> <li>Reset methods to reset the service/record/list.</li> <li>CRUDL methods that update/use the current record/list.</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFactoryControllerService<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">TRecord</span> Record <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> Records <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> RecordCount <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Records<span class="token punctuation">?.</span>Count <span class="token operator">??</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> RecordId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> RecordGUID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DbTaskResult</span> DbResult <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Paginator</span> Paginator <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsRecord <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Record <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>RecordId <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> HasRecords <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Records <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Records<span class="token punctuation">.</span>Count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsNewRecord <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>IsRecord <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>RecordId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler</span> RecordHasChanged<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler</span> ListHasChanged<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">ResetRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">ResetListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">GetRecordsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">SaveRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetRecordAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">NewRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">DeleteRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="factorycontrollerservice"><a href="#factorycontrollerservice" class="header-anchor">#</a> FactoryControllerService</h4> <p><code>FactoryControllerService</code> is abstract implementation of the <code>IFactoryControllerService</code>.  It contains all the boilerplate code.  Much of the code is self evident.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">FactoryControllerService<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span><span class="token punctuation">,</span> <span class="token class-name">IFactoryControllerService<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// unique ID for this instance</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Record Property.  Triggers Event when changed.</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">TRecord</span> Record
    <span class="token punctuation">{</span>
        <span class="token keyword">get</span> <span class="token operator">=&gt;</span> _record<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_record <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>RecordHasChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">,</span> EventArgs<span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">TRecord</span> _record <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// Recordset Property. Triggers Event when changed.</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> Records
    <span class="token punctuation">{</span>
        <span class="token keyword">get</span> <span class="token operator">=&gt;</span> _records<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_records <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ListHasChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">,</span> EventArgs<span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> _records <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> RecordId <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Record<span class="token punctuation">?.</span>ID <span class="token operator">??</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> RecordGUID <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Record<span class="token punctuation">?.</span>GUID <span class="token operator">??</span> Guid<span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbTaskResult</span> DbResult <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// Property for the Paging object that controls paging and interfaces with the UI Paging Control </span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Paginator</span> Paginator <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsRecord <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Record <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>RecordId <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> HasRecords <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Records <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Records<span class="token punctuation">.</span>Count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsNewRecord <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>IsRecord <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>RecordId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">/// Data Service for data access</span>
    <span class="token keyword">protected</span> <span class="token return-type class-name">IFactoryDataService</span> DataService <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler</span> RecordHasChanged<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler</span> ListHasChanged<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">FactoryControllerService</span><span class="token punctuation">(</span><span class="token class-name">IFactoryDataService</span> factoryDataService<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>DataService <span class="token operator">=</span> factoryDataService<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Paginator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Paginator</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Paginator<span class="token punctuation">.</span>PageChanged <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>OnPageChanged<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Method to reset the service</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Record <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Records <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Method to reset the record list</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">ResetListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Records <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Method to reset the Record</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">ResetRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Record <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Method to get a recordset</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">GetRecordsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Records <span class="token operator">=</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Paginator<span class="token punctuation">.</span>GetData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Paginator<span class="token punctuation">.</span>RecordCount <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetRecordListCountAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ListHasChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> EventArgs<span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Method to get a record</span>
    <span class="token comment">/// if id &lt; 1 will create a new record</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetRecordAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>Record <span class="token operator">=</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>Record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>IsRecord<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Method to get the current record count</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetRecordListCountAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">SaveRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>RecordId <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>DbResult <span class="token operator">=</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>DbResult <span class="token operator">=</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token function">UpdateRecordAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetRecordsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DbResult<span class="token punctuation">.</span>IsOK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">DeleteRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>DbResult <span class="token operator">=</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DbResult<span class="token punctuation">.</span>IsOK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">NewRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Record <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">TRecord</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnPageChanged</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetRecordsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifyRecordChanged</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>RecordHasChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifyListChanged</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ListHasChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="weatherforecastcontrollerservice"><a href="#weatherforecastcontrollerservice" class="header-anchor">#</a> WeatherForecastControllerService</h4> <p>The boilerplating payback comes in the declaration of <code>WeatheForcastControllerService</code>:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastControllerService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">FactoryControllerService<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">WeatherForecastControllerService</span><span class="token punctuation">(</span><span class="token class-name">IFactoryDataService</span> factoryDataService<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>factoryDataService<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="wrap-up"><a href="#wrap-up" class="header-anchor">#</a> Wrap Up</h2> <p>This article shows how the data services can be built using a set of abstract classes implementing boilerplate code for CRUDL operations.  I've purposely kept error checking in the code to a minimum, to make it much more readable.  You can implement as little or as much as you like.</p> <p>Some key points to note:</p> <ol><li>Aysnc code is used wherever possible.  The data access functions are all async.</li> <li>Generics make much of the boilerplating possible.  They create complexity, but are worth the effort.</li> <li>Interfaces are crucial for Dependancy Injection and UI boilerplating.</li></ol> <p>If you're reading this article well into the future, check the readme in the repository for the latest version of the article set.</p> <h2 id="history"><a href="#history" class="header-anchor">#</a> History</h2> <ul><li>15-Sep-2020: Initial version.</li> <li>2-Oct-2020: Minor formatting updates and typo fixes.</li> <li>17-Nov-2020: Major Blazor.CEC library changes.  Change to ViewManager from Router and new Component base implementation.</li> <li>28-Mar-2021: Major updates to Services, project structure and data editing.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.de94086e.js" defer></script><script src="/assets/js/2.0005fb99.js" defer></script><script src="/assets/js/8.d8750b3a.js" defer></script>
  </body>
</html>
