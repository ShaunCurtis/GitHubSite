<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Async Programming in Blazor</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.b25df986.css" as="style"><link rel="preload" href="/assets/js/app.de94086e.js" as="script"><link rel="preload" href="/assets/js/2.0005fb99.js" as="script"><link rel="preload" href="/assets/js/14.846c76b5.js" as="script"><link rel="prefetch" href="/assets/js/10.1b1bac62.js"><link rel="prefetch" href="/assets/js/11.d5ccb284.js"><link rel="prefetch" href="/assets/js/12.041ebee5.js"><link rel="prefetch" href="/assets/js/13.32117bf8.js"><link rel="prefetch" href="/assets/js/15.50f29b11.js"><link rel="prefetch" href="/assets/js/16.1209f32e.js"><link rel="prefetch" href="/assets/js/17.05965361.js"><link rel="prefetch" href="/assets/js/18.0deb6c5a.js"><link rel="prefetch" href="/assets/js/19.c0b807a9.js"><link rel="prefetch" href="/assets/js/20.eca6b9de.js"><link rel="prefetch" href="/assets/js/21.83db0212.js"><link rel="prefetch" href="/assets/js/22.8c84fb58.js"><link rel="prefetch" href="/assets/js/23.e8ce4875.js"><link rel="prefetch" href="/assets/js/24.fd7b0084.js"><link rel="prefetch" href="/assets/js/25.cdf82bd3.js"><link rel="prefetch" href="/assets/js/26.f554011d.js"><link rel="prefetch" href="/assets/js/27.df20cf08.js"><link rel="prefetch" href="/assets/js/28.2318a9ac.js"><link rel="prefetch" href="/assets/js/29.628dd84b.js"><link rel="prefetch" href="/assets/js/3.1a98c051.js"><link rel="prefetch" href="/assets/js/30.47ff2eac.js"><link rel="prefetch" href="/assets/js/31.eb71eabe.js"><link rel="prefetch" href="/assets/js/32.c74d3c6a.js"><link rel="prefetch" href="/assets/js/33.19a01216.js"><link rel="prefetch" href="/assets/js/34.aed43787.js"><link rel="prefetch" href="/assets/js/35.b40f612a.js"><link rel="prefetch" href="/assets/js/36.ae14410d.js"><link rel="prefetch" href="/assets/js/37.74d7c586.js"><link rel="prefetch" href="/assets/js/38.54528dd5.js"><link rel="prefetch" href="/assets/js/39.e8c514e8.js"><link rel="prefetch" href="/assets/js/4.3083dbc5.js"><link rel="prefetch" href="/assets/js/40.5c97b972.js"><link rel="prefetch" href="/assets/js/41.7a1cf8ba.js"><link rel="prefetch" href="/assets/js/42.f449294e.js"><link rel="prefetch" href="/assets/js/43.432c7e84.js"><link rel="prefetch" href="/assets/js/44.d56e3403.js"><link rel="prefetch" href="/assets/js/45.c6081de4.js"><link rel="prefetch" href="/assets/js/5.28112fa8.js"><link rel="prefetch" href="/assets/js/6.50910651.js"><link rel="prefetch" href="/assets/js/7.90248bbe.js"><link rel="prefetch" href="/assets/js/8.d8750b3a.js"><link rel="prefetch" href="/assets/js/9.ab982ebf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b25df986.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="async-programming-in-blazor"><a href="#async-programming-in-blazor" class="header-anchor">#</a> Async Programming in Blazor</h1> <p>This article provides an insight into async programming in Blazor.  I make no claim to be an expert: this is a summary of my recent experiences and knowledge acquisition.  There's some original content, but most of what I've written has been gleaned from other author's work.  There's a list of links at the bottom to articles, blogs and other material I've found useful, and have mined in writing this article.</p> <p>This is a major revision to the earlier article published in November 2020.</p> <p>Blazor applications rely on remote databases and services and need to handle latency and delay.  Understanding and using async methodologies is a key skill Blazor programmers need to acquire.</p> <h2 id="what-do-you-know-about-async-hronous-programming"><a href="#what-do-you-know-about-async-hronous-programming" class="header-anchor">#</a> What do you know about Async(hronous) Programming?</h2> <p>Most of us think we know what async programming is all about.  I started developing Blazor applications with that delusion.  I soon became painfully aware of just how shallow that knowledge was. Yes, sure, I knew what it was and could explain it in broad terms. But actually write structured and well behaved code? There followed a somewhat painful lesson in humility.</p> <h2 id="so-what-is-async-hronous-programming"><a href="#so-what-is-async-hronous-programming" class="header-anchor">#</a> So, What is Async(hronous) Programming?</h2> <p>Put simply, asynchronous programming lets us multi-task - like driving a car whilst talking to the passenger.  There's a very good explanation on the Microsoft Docs site describing <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/async/" target="_blank" rel="noopener noreferrer">how to make a parallel task hot or sequential luke warm breakfast<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="when-should-we-use-it"><a href="#when-should-we-use-it" class="header-anchor">#</a> When should we use it?</h2> <p>There are three principle situations were asynchronous processes have significant advantages over a single sequential process:</p> <ol><li>Processor Intensive Operations - such as complex mathematical calculations.</li> <li>I/0 Operations - where tasks are offloaded to either subsystems on the same computer, or run on remote computers.</li> <li>Improved User Interface experience.</li></ol> <p>In processor intensive operations, you want multiple processors or cores.  Hand off most of the processing to these cores and the program can interact with the UI on the main process updating progress and handling user interaction.  Multi-tasking on the same processor buys nothing.  The program doen't need more balls to juggle, just more jugglers.</p> <p>On the other hand I/O operations don't need multiple processors.  They dispatch requests to sub-systems or remote services and await responses.  It's multi-tasking that now buys time - set up and monitor several tasks at once and wait for them to complete.  Wait time becomes dependant on the longest running task, not the sum of the tasks.</p> <p>Run everything serially and the User Interface gets locked whever a task is running.  Asynchronous tasks free up the UI process. The UI can interact with the user while tasks are running.</p> <p>In Blazor we're principly interested in I/O and UI operations.  Any serious processor intensive operations should be handled by a service.</p> <h2 id="tasks-threading-scheduling-contexts"><a href="#tasks-threading-scheduling-contexts" class="header-anchor">#</a> Tasks, Threading, Scheduling, Contexts</h2> <p>There's an excellent article <a href="https://www.codeproject.com/Articles/5299501/Async-Await-Explained-with-Diagrams-and-Examples" target="_blank" rel="noopener noreferrer">here by David Deley<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> that explains things better than I did in the orginal version of this article.  I'll not regurgitate it.</p> <p>In the Blazor context, as with desktop applications, there's a <code>SynchronisationContext</code> on a UI thread: all UI work must take place on the UI Thread.  In Web Assembly, you only have one thread - the UI Thread.  You're running in the browser context, and currently that's one thread.  This may change in the future, but at present, <code>Task.Run</code> doesn't do what you think it should do.  Block that thread and deadlock. Blazor Server has both the UI thread and a threadpool.</p> <h2 id="asnyc-in-the-ui"><a href="#asnyc-in-the-ui" class="header-anchor">#</a> Asnyc in the UI</h2> <p>The Blazor UI is driven by events.  The initial render events, and then button clicks, data entry, ...</p> <h3 id="component-events"><a href="#component-events" class="header-anchor">#</a> Component Events</h3> <p>The initial render events have both synchronous and asynchronous versions.  <code>OnInitialized()</code> and <code>OnInitialisedAsync</code> - often shortened to <code>OnInitialised{Async}</code>.  Which should you use?  My view, and it's personal not best practice, is forget the synchronous version.  Go async from the start - Async ann the Way.   If you intend to get data from somewhere it's going to be asynchronous.</p> <p>So you're standard patterns for <code>OnInitializedAsync</code> are:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">OnInitializedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// sync or async code</span>
    <span class="token keyword">await</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnInitializedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">OnInitializedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// some sync code</span>
    <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>ComponentBase</code> implementation is:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task</span> <span class="token function">OnInitializedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
</code></pre></div><p>In my <em>Blazor.Database</em> repo the <code>RecordFormBase</code> implementation looks like:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">OnInitializedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Get the record - code separated out so can be called outside the `OnInitializedAsync` event</span>
    <span class="token keyword">await</span> <span class="token function">LoadRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnInitializedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The same applies to <code>OnParametersSet{Async}</code>.</p> <p>Note that with both events and <code>OnAfterRender{Async}</code>, the sync version is called - and therefore completes - before the async version.</p> <h4 id="component-render-events"><a href="#component-render-events" class="header-anchor">#</a> Component Render Events</h4> <p>In the component process it's also important to understand when render events occur.  The main render occurs after the <code>OnParametersSet{Async}</code> events complete.  However, an initial render occurs if (and only if) <code>OnInitializedAsync</code> yields before completing.  This gives us the opportunity to display a &quot;loading&quot; message/component/notification during the component initilaization process.</p> <p>The following simple page demonstrates this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>@page <span class="token string">&quot;/testasync&quot;</span>
<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h3<span class="token operator">&gt;</span>@_message<span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
@code <span class="token punctuation">{</span>    
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">string</span></span> _message <span class="token operator">=</span> <span class="token string">&quot;Starting&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">OnInitializedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _message <span class="token operator">=</span> <span class="token string">&quot;Sync Code running&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _message <span class="token operator">=</span> <span class="token string">&quot;Async Code completed&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="ui-events"><a href="#ui-events" class="header-anchor">#</a> UI Events</h3> <p>We'll concentrate on mouse clicks on buttons as an example.</p> <p>Here's a simple example.</p> <div class="language-html extra-class"><pre class="language-html"><code>@page &quot;/asyncbuttons&quot;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container m-2 px-3 p-t bg-light<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>row pt-2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>Event Buttons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>row pt-2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-6<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            @value1
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-6<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn btn-warning<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>this.OnClick<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Click<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>row pt-2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-6<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            @value1
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-6<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn btn-warning<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(e) =&gt; this.OnClick(e)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Click<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>And the code:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>@code <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">string</span></span> value1 <span class="token operator">=</span> <span class="token string">&quot;notset&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnClick</span><span class="token punctuation">(</span><span class="token class-name">MouseEventArgs</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        value1 <span class="token operator">=</span> <span class="token string">&quot;Onclick started&quot;</span><span class="token punctuation">;</span>
            <span class="token comment">// run some synchronous code</span>
        value1 <span class="token operator">=</span> <span class="token string">&quot;Onclick complete&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>These work fine.  Now let's introduce a Task.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>@code <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Onclick</span><span class="token punctuation">(</span><span class="token class-name">MouseEventArgs</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        value1 <span class="token operator">=</span> <span class="token string">&quot;Onclick started&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">DoSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        value1 <span class="token operator">=</span> <span class="token string">&quot;Onclick complete&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token return-type class-name">Task</span> <span class="token function">DoSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Task<span class="token punctuation">.</span><span class="token function">Yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This also works.</p> <p>Finally let's make <code>DoSomethingAsync</code> yield correctly.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>@code <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnClick</span><span class="token punctuation">(</span><span class="token class-name">MouseEventArgs</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        value1 <span class="token operator">=</span> <span class="token string">&quot;Onclick started&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">DoSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        value1 <span class="token operator">=</span> <span class="token string">&quot;Onclick complete&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">DoSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now <code>Value1</code> shows <em>Onclick started</em>.  If you put a break in the code at the end of <code>OnClick</code> you'll find that <code>value1</code> is actually set to <em>Onclick complete</em> but the UI shows the previous value.</p> <p>At this point the temptation is to call <code>StateHasChanged</code> at the end to fix the problem.  It'll work, but you're only masking the real problem.</p> <p>So what's happening?</p> <p>Blazor is putting the <code>OnClick</code> event into the <code>SynchronisationContext</code> queue as an asynchronous operation that looks something like:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>Await <span class="token punctuation">{</span>UIEvent code <span class="token keyword">as</span> <span class="token class-name">task</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">Invoke</span><span class="token punctuation">(</span>StateHasChanged<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In the first codeblock above, the code is all synchronous so runs to completion before the UI update.  In the second block, we may have wrapped things in Tasks, but it's all synchronous so again runs to completion - calling <code>Task.Yield()</code> without an <code>await</code> kicks it off but doesn't wait on it.</p> <p>In the final codeblock we do a proper yield on an <code>await</code>.  However, our <code>OnClick</code> event handler returns a void.  The top level Task in the <code>SynchronisationContext</code> queue has nothing to wait on so runs to completion - re-rendering the component - before <code>DoSomethingAsync</code> completes.  <code>Task.Yield()</code> effectively kicks the code following it (including itself returning a completed task) down the <code>SynchronisationContext</code> queue, allowing the top level task to complete first.</p> <p>To solve this problem we change the event hanlder to return a <code>Task</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>@code <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OnClick</span><span class="token punctuation">(</span><span class="token class-name">MouseEventArgs</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        value1 <span class="token operator">=</span> <span class="token string">&quot;Onclick started&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">DoSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        value1 <span class="token operator">=</span> <span class="token string">&quot;Onclick complete&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now the top level task has something to wait on and only re-renders when the event handler <code>Task</code> completes.  Our top level task will yield to the <code>SynchronisationContext</code> queue, letting it continue with other tasks.</p> <p>You will often see this pattern.  It isn't required, it just wraps a <code>Task</code> inside another <code>Task</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn btn-warning&quot;</span> @onclick<span class="token operator">=</span><span class="token string">&quot;async (e) =&gt; await this.OnClick(e)&quot;</span><span class="token operator">&gt;</span>Click<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
</code></pre></div><h2 id="component-events-and-eventcallbacks"><a href="#component-events-and-eventcallbacks" class="header-anchor">#</a> Component Events and EventCallbacks</h2> <p>Consider this code:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token operator">&lt;</span><span class="token class-name">MyComponent</span> @onclick<span class="token operator">=</span><span class="token string">&quot;() =&gt; OnClick()&quot;</span><span class="token operator">&gt;</span>Hello<span class="token operator">&lt;</span>MyComponent<span class="token operator">&gt;</span>
</code></pre></div><p>Components aren't html elements.  There's no <code>OnClick</code> event on <code>MyComponent</code> unless you've created an EventCallback.</p> <p>The code below shows the code patterns to use for full async behaviour through components.  <code>BtnClick</code> in the component uses <code>InvokeAsync</code> to call the EventCallback.  In the parent the delegate registered with the <code>OnClick</code> EventCallback passes an awaitable  Task back to the component. Async all the way.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn btn-warning&quot;</span> @onclick<span class="token operator">=</span><span class="token string">&quot;this.BtnClick&quot;</span><span class="token operator">&gt;</span>@ChildContent<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>

@code <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Parameter</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name">EventCallback<span class="token punctuation">&lt;</span>MouseEventArgs<span class="token punctuation">&gt;</span></span> OnClick <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Parameter</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name">RenderFragment</span> ChildContent <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">BtnClick</span><span class="token punctuation">(</span><span class="token class-name">MouseEventArgs</span> e<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> OnClick<span class="token punctuation">.</span><span class="token function">InvokeAsync</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>row pt-2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-6<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        @value5
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-6<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UIButton</span> <span class="token attr-name">OnClick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>OnclickComponent<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>UIButton</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">string</span></span> value5 <span class="token operator">=</span> <span class="token string">&quot;notset&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OnclickComponent</span><span class="token punctuation">(</span><span class="token class-name">MouseEventArgs</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    value5 <span class="token operator">=</span> <span class="token string">&quot;Onclick started&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">DoSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    value5 <span class="token operator">=</span> <span class="token string">&quot;Onclick complete&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="service-events"><a href="#service-events" class="header-anchor">#</a> Service Events</h2> <p>The second source of events in the UI is service events to which a component has subscribed.  The most common are notifications of list or object updates.</p> <p>The correct pattern for these looks like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnRecordChange</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Do something</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">InvokeAsync</span><span class="token punctuation">(</span>StateHasChanged<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The handler is declared void.  The code was invoked like this <code>RecordChanged?.Invoke(this, EventArgs.Empty)</code>.  There's no  await and it's not expecting any return. <code>OnRecordChange</code> is the top level event.  The event is also outside the component rendering process, so if the UI needs updating <code>StateHasChanged</code> needs to be called.</p> <p><code>InvokeAsync</code> is a <code>ComponentBase</code> method that looks like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">Func<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&gt;</span></span> workItem<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> _renderHandle<span class="token punctuation">.</span>Dispatcher<span class="token punctuation">.</span><span class="token function">InvokeAsync</span><span class="token punctuation">(</span>workItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>_renderHandle</code> is passed to components when they are attached to the RenderTree by the RenderTreeBuilder.  <code>InvokeAsync</code> uses the supplied <code>SynchronisationContext</code> <code>Dispatcher</code> to invoke <code>StateHasChanged</code>, ensuring it's run on the UI thread.</p> <h2 id="blocking-and-deadlocking"><a href="#blocking-and-deadlocking" class="header-anchor">#</a> Blocking and Deadlocking</h2> <p>One of the biggest challenges you'll face is the Deadlock. Async code that either always locks, or locks under load. In Blazor, this manifests itself as a locked page. The lights are on but there's no one at home. You've killed the application process running your SPA instance. The only way out is to reload the page (F5).</p> <p>The normal reason is blocking code - program execution on the application thread is halted waiting for a task to complete that's further down the queue. The halt blocks execution of the code it's waiting on. Deadlock. Moveove the task to the threadpool, the task completes and the block unblocks. However, no UI updates happen. Shifting code to the taskpool to unblock the application thread isn't the answer. Nor is blocking threadpool threads.  Under load the application may block all the threads available.</p> <p>Here's so classic blocking code - in this case a button click event in the UI.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ButtonClicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>SomeService<span class="token punctuation">.</span><span class="token function">GetAListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>and more:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">GetAListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> myDataContext<span class="token punctuation">.</span>somedataset<span class="token punctuation">.</span><span class="token function">GetListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> ret <span class="token operator">=</span> task<span class="token punctuation">.</span>Result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><em>Task.Wait()</em> and <em>task.Result</em> are blocking actions.  They stop execution on the thread and wait for <em>task</em> to complete. <em>Task</em> can't complete because the thread is blocked.  Unless you really understand what you're doing - you probably won't be reading this if you do - <strong>don't use them</strong>.  If you think you need to, re-think your design.</p> <h2 id="recommendations"><a href="#recommendations" class="header-anchor">#</a> Recommendations</h2> <ol><li><strong>Async and Await All The Way</strong>. Don't mix synchronous and asynchronous methods.  Start at the bottom - the data or process interface - and code async all the way up though the data and business/logic layers to the UI.  Blazor components implement both async and sync events, so there's no reason for sync if your base library provides async interfaces.</li> <li>Only assign processor intensive tasks to the threadpool.  Don't assign normal tasks to the threadpool because you can.</li> <li>Don't use <em>Task.Run()</em> in your libraries. Keep that decision as far up in the application code as possible. Make your libraries context agnostic.</li> <li>Never block in your libraries.  Seems obvious but... if you absolutely must block do it in the front end.</li> <li>Always use <em>async</em> and <em>await</em>, don't get fancy.</li> <li>If your library provides both async and sync calls, code them separately.  &quot;Code it once&quot; best practice doesn't apply here.  NEVER call one from the other if you don't want to shoot yourself in the foot at some point!</li> <li>Only use <em>async void</em> for class based event handlers.  Never for anywhere else.</li></ol> <h4 id="useful-resources-and-sources-of-my-knowledge"><a href="#useful-resources-and-sources-of-my-knowledge" class="header-anchor">#</a> Useful Resources and Sources of My Knowledge</h4> <p><a href="https://www.codeproject.com/Articles/5299501/Async-Await-Explained-with-Diagrams-and-Examples" target="_blank" rel="noopener noreferrer">David Deley Async/Await Explained<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://docs.microsoft.com/en-us/dotnet/csharp/async#:~:text=C%23%20has%20a%20language-level%20asynchronous%20programming%20model%20which,is%20known%20as%20the%20Task-based%20Asynchronous%20Pattern%20%28TAP%29." target="_blank" rel="noopener noreferrer">Async Programming - Microsoft<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://blog.stephencleary.com/2014/04/a-tour-of-task-part-0-overview.html" target="_blank" rel="noopener noreferrer">Stephen Cleary - A Tour of Task and other articles<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://medium.com/rubrikkgroup/understanding-async-avoiding-deadlocks-e41f8f2c6f5d" target="_blank" rel="noopener noreferrer">Eke Peter - Understanding Async, Avoiding Deadlocks in C#<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://docs.microsoft.com/en-us/archive/msdn-magazine/2013/march/async-await-best-practices-in-asynchronous-programming" target="_blank" rel="noopener noreferrer">Stephen Cleary - MSDN - Best Practices in Asynchronous Programming<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Many StackOverflow Answers to Questions</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.de94086e.js" defer></script><script src="/assets/js/2.0005fb99.js" defer></script><script src="/assets/js/14.846c76b5.js" defer></script>
  </body>
</html>
