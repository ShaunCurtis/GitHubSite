<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Building Blazor Edit Forms | Cold Elm Coders</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.44eeee96.css" as="style"><link rel="preload" href="/assets/js/app.a728ba5d.js" as="script"><link rel="preload" href="/assets/js/3.3d8b86b8.js" as="script"><link rel="preload" href="/assets/js/49.6869f1c2.js" as="script"><link rel="prefetch" href="/assets/js/1.3b0fc1ec.js"><link rel="prefetch" href="/assets/js/10.a274dc46.js"><link rel="prefetch" href="/assets/js/11.162f7736.js"><link rel="prefetch" href="/assets/js/12.9b137fad.js"><link rel="prefetch" href="/assets/js/13.b0705d6f.js"><link rel="prefetch" href="/assets/js/14.90a14690.js"><link rel="prefetch" href="/assets/js/15.7d24e989.js"><link rel="prefetch" href="/assets/js/16.3321fd05.js"><link rel="prefetch" href="/assets/js/17.2a730ee9.js"><link rel="prefetch" href="/assets/js/18.93009d66.js"><link rel="prefetch" href="/assets/js/19.dd7916e7.js"><link rel="prefetch" href="/assets/js/20.06257388.js"><link rel="prefetch" href="/assets/js/21.ad06fee8.js"><link rel="prefetch" href="/assets/js/22.57c9e301.js"><link rel="prefetch" href="/assets/js/23.8c523222.js"><link rel="prefetch" href="/assets/js/24.c3de66a9.js"><link rel="prefetch" href="/assets/js/25.bb1f5210.js"><link rel="prefetch" href="/assets/js/26.1e04e64c.js"><link rel="prefetch" href="/assets/js/27.a24ae7a8.js"><link rel="prefetch" href="/assets/js/28.3cc80874.js"><link rel="prefetch" href="/assets/js/29.92a16acf.js"><link rel="prefetch" href="/assets/js/30.ba76c29c.js"><link rel="prefetch" href="/assets/js/31.4fa00807.js"><link rel="prefetch" href="/assets/js/32.f6618632.js"><link rel="prefetch" href="/assets/js/33.4dc1d2a9.js"><link rel="prefetch" href="/assets/js/34.266d295c.js"><link rel="prefetch" href="/assets/js/35.03c4dbda.js"><link rel="prefetch" href="/assets/js/36.cfb72d79.js"><link rel="prefetch" href="/assets/js/37.44581004.js"><link rel="prefetch" href="/assets/js/38.b49cb2d8.js"><link rel="prefetch" href="/assets/js/39.a96a4623.js"><link rel="prefetch" href="/assets/js/4.0476436c.js"><link rel="prefetch" href="/assets/js/40.47e33d12.js"><link rel="prefetch" href="/assets/js/41.96a37d4b.js"><link rel="prefetch" href="/assets/js/42.48f1e665.js"><link rel="prefetch" href="/assets/js/43.008951cc.js"><link rel="prefetch" href="/assets/js/44.b3b98e4c.js"><link rel="prefetch" href="/assets/js/45.d83537f4.js"><link rel="prefetch" href="/assets/js/46.78680b50.js"><link rel="prefetch" href="/assets/js/47.12a37bbb.js"><link rel="prefetch" href="/assets/js/48.2c8d0d86.js"><link rel="prefetch" href="/assets/js/5.c21f6997.js"><link rel="prefetch" href="/assets/js/50.ec126d1b.js"><link rel="prefetch" href="/assets/js/51.35e75015.js"><link rel="prefetch" href="/assets/js/52.1a18ae8f.js"><link rel="prefetch" href="/assets/js/53.ab8d3568.js"><link rel="prefetch" href="/assets/js/54.27cea7d8.js"><link rel="prefetch" href="/assets/js/55.8a049d96.js"><link rel="prefetch" href="/assets/js/56.4224eefd.js"><link rel="prefetch" href="/assets/js/57.0714983c.js"><link rel="prefetch" href="/assets/js/58.dcaa0649.js"><link rel="prefetch" href="/assets/js/59.a8f404ff.js"><link rel="prefetch" href="/assets/js/6.c00c814d.js"><link rel="prefetch" href="/assets/js/60.041dbde1.js"><link rel="prefetch" href="/assets/js/61.96a9eef9.js"><link rel="prefetch" href="/assets/js/62.20def6a6.js"><link rel="prefetch" href="/assets/js/63.c58c947f.js"><link rel="prefetch" href="/assets/js/64.bc57bfde.js"><link rel="prefetch" href="/assets/js/65.654f70a6.js"><link rel="prefetch" href="/assets/js/7.c2996796.js"><link rel="prefetch" href="/assets/js/8.a4f8ac88.js"><link rel="prefetch" href="/assets/js/9.62cada5e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.44eeee96.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Cold Elm Coders</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  Articles
</a></div><div class="nav-item"><a href="/posts/" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="/ArchivedArticles/" class="nav-link">
  Old Articles
</a></div><div class="nav-item"><a href="/Building-a-Database-Application-in-Blazor/" class="nav-link">
  Database Application
</a></div><div class="nav-item"><a href="https://cec-blazor-examples.azurewebsites.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Demo Site
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  Articles
</a></div><div class="nav-item"><a href="/posts/" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="/ArchivedArticles/" class="nav-link">
  Old Articles
</a></div><div class="nav-item"><a href="/Building-a-Database-Application-in-Blazor/" class="nav-link">
  Database Application
</a></div><div class="nav-item"><a href="https://cec-blazor-examples.azurewebsites.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Demo Site
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>My Articles</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/" aria-current="page" class="sidebar-link">Articles</a></li><li><a href="/articles/Blazor-DataList-Control.html" class="sidebar-link">A Blazor DataList Control</a></li><li><a href="/articles/Blazor-CSS.html" class="sidebar-link">CSS in Blazor</a></li><li><a href="/articles/Modal-Dialog.html" class="sidebar-link">A Blazor Modal Dialog</a></li><li><a href="/articles/Blazor-Components.html" class="sidebar-link">A Deep Dive into Blazor Components</a></li><li><a href="/articles/Building-Edit-Forms.html" aria-current="page" class="active sidebar-link">Building Blazor Edit Forms</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/Building-Edit-Forms.html#form-exits" class="sidebar-link">Form Exits</a></li><li class="sidebar-sub-header"><a href="/articles/Building-Edit-Forms.html#form-edit-state" class="sidebar-link">Form Edit State</a></li><li class="sidebar-sub-header"><a href="/articles/Building-Edit-Forms.html#the-solution-in-action" class="sidebar-link">The Solution in Action</a></li></ul></li><li><a href="/articles/EditFormState.html" class="sidebar-link">The Blazor EditFormState Control</a></li><li><a href="/articles/Blazor-AllinOne.html" class="sidebar-link">Blazor AllinOne - Multi SPA Hosting</a></li><li><a href="/articles/Async-Programming-in-DotNetCore.html" class="sidebar-link">Async Programming in DotNetCore</a></li><li><a href="/articles/A-Flexible-App.html" class="sidebar-link">Adding Dynamic Routing, Layouts and RouteViews to the Blazor App Component</a></li><li><a href="/articles/Hydra Full Article.html" class="sidebar-link">Blazor Hydra - Multi SPA Hosting</a></li><li><a href="/articles/Inline-Dialog.html" class="sidebar-link">The Blazor Inline Dialog Control</a></li><li><a href="/articles/BlazorAsyncProgramming.html" class="sidebar-link">Async Programming in Blazor</a></li><li><a href="/articles/ValidationFormState.html" class="sidebar-link">A Blazor Validation Control</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="managing-form-edit-state-in-blazor"><a href="#managing-form-edit-state-in-blazor" class="header-anchor">#</a> Managing Form Edit State in Blazor</h1> <p>You've edited data in a form.  You click on a link in the navigation bar, click the back button, hit a favourite link.  Do you really want to exit the form ? Maybe, maybe not.  What you probably want is to be at least warned if you have unsaved data in the form you are exiting.</p> <p><img src="/siteimages/Articles/Edit-Forms/Dirty-Exit.png" alt="Dirty Editor"></p> <p>This code is part of a larger Blazor Database template project. The repository for the project is <a href="https://github.com/ShaunCurtis/Blazor.Database" target="_blank" rel="noopener noreferrer">Blazor.Database Repository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>The demo site is here - <a href="https://cec-blazor-server.azurewebsites.net/" target="_blank" rel="noopener noreferrer">https://cec-blazor-database.azurewebsites.net/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="form-exits"><a href="#form-exits" class="header-anchor">#</a> Form Exits</h2> <p>There are three (controlled) ways a user can exit a form:</p> <ol><li>Intra Form Navigation - Clicking on an Exit button within the form.</li> <li>Intra Application Navigation - Clicking on a link in a navigation bar outside the form, clicking on the forward or back buttons on the browser.</li> <li>Extra Application Navigation - entering a new Url in the address bar, clicking on a favourite, closing the browser Tab or application.</li></ol> <p>We have no control over killing the browser - say a reboot or system crash - so I won't consider that here.</p> <h2 id="form-edit-state"><a href="#form-edit-state" class="header-anchor">#</a> Form Edit State</h2> <p>The first step is to track edit state - are any of the current entered values different from the stored values?  Out-of-the-box Blazor has no mechanisms to do this.  We need an edit state manager.</p> <p>This is implemented as two classes.</p> <ol><li><code>EditStateService</code> - is a scoped service that holds the state of the current edit form during the SPA session.</li> <li><code>EditFormState</code> - is a component that interacts with the <code>EditContext</code> within a form.  It stores the initial <code>Model</code> values and any user updates in an <code>EditFieldCollection</code>.  It updates the <code>EditStateService</code> as any changes take place.</li></ol> <h3 id="editstateservice"><a href="#editstateservice" class="header-anchor">#</a> EditStateService</h3> <p><code>EditStateService</code> is a scoped service state container that tracks the edit state of the current form.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EditStateService</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">bool</span></span> _isDirty<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> RecordID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsDirty <span class="token operator">=&gt;</span> _isDirty <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>RecordID <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Data <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> EditFormUrl <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> ShowEditForm <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token operator">!</span>String<span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span>EditFormUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> IsDirty<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> DoFormReload <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler</span> RecordSaved<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler<span class="token punctuation">&lt;</span>EditStateEventArgs<span class="token punctuation">&gt;</span></span> EditStateChanged<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetEditState</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> data<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Data <span class="token operator">=</span> data<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_isDirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ClearEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_isDirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ResetEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>RecordID <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_isDirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>EditFormUrl <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifyRecordSaved</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> RecordSaved<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> EventArgs<span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifyEditStateChanged</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">bool</span></span> dirtyState<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> EditStateChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> EditStateEventArgs<span class="token punctuation">.</span><span class="token function">NewArgs</span><span class="token punctuation">(</span>dirtyState<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="editformstate"><a href="#editformstate" class="header-anchor">#</a> EditFormState</h3> <p><code>EditFormState</code> is a UI control with no UI output - like <code>EditForm</code>.  It's placed within an <code>EditForm</code> and captures the cascaded <code>EditContext</code>, and the <code>EditStateService</code> through dependency injection.  It exposes an <code>EditStateChanged</code> event and an <code>IsDirty</code> property.</p> <p><code>EditFormState</code> reads all the write properties from the <code>EditContext</code> and saves them to an <code>EditFields</code> collection.</p> <p><code>EditField</code> looks like this.  Note all but <code>EditedValue</code> are <code>init</code> record type properties.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EditField</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> FieldName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> init<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> GUID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> init<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> Value <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> init<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> EditedValue <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> Model <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> init<span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsDirty
        <span class="token punctuation">{</span>
            <span class="token keyword">get</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> EditedValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">!</span>Value<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>EditedValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Value <span class="token keyword">is</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> EditedValue <span class="token keyword">is</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token function">EditField</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> model<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> fieldName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> <span class="token keyword">value</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>Model <span class="token operator">=</span> model<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>FieldName <span class="token operator">=</span> fieldName<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>EditedValue <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>GUID <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>EditedValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><code>EditFieldCollection</code> implements <code>IEnumerable</code>.  It provides:</p> <ol><li>An <code>IsDirty</code> property which checks the state of all the <code>EditFields</code> in the collection.</li> <li>A set of getters and setters for adding and setting the edit state.</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EditFieldCollection</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IEnumerable</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>EditField<span class="token punctuation">&gt;</span></span> _items <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>EditField<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Count <span class="token operator">=&gt;</span> _items<span class="token punctuation">.</span>Count<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">Action<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> FieldValueChanged<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsDirty <span class="token operator">=&gt;</span> _items<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>IsDirty<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> _items<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ResetValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> _items<span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token range operator">..</span><span class="token range operator">..</span><span class="token punctuation">.</span> lots of getters <span class="token keyword">and</span> setters <span class="token keyword">and</span> IEnumerator implementation code
</code></pre></div><p><code>EditFormState</code> Properties/Fields</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">bool</span></span> disposedValue<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">EditFieldCollection</span> EditFields <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EditFieldCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CascadingParameter</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name">EditContext</span> EditContext <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Inject</span></span><span class="token punctuation">]</span> <span class="token keyword">private</span> <span class="token return-type class-name">EditStateService</span> EditStateService <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Inject</span></span><span class="token punctuation">]</span> <span class="token keyword">private</span> <span class="token return-type class-name">IJSRuntime</span> _js <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

</code></pre></div><p>When the component is initilaised it:</p> <ol><li>Loads <code>EditFields</code> from <code>EditContext.Model</code>.</li> <li>Checks the <code>EditStateService</code> and if it's dirty gets and deserializes <code>Data</code>.</li> <li>Sets the <code>EditedValue</code> for each <code>EditField</code> to the saved <code>Data</code> value.</li> <li>Applies the saved <code>Data</code> values to the <code>EditContext.Model</code>.</li> <li>Hooks up <code>FieldChanged</code> to <code>OnFieldChanged</code> on <code>EditContext</code> to get all the user edits.</li> <li>Hooks up <code>OnSave</code> to <code>RecordSaved</code> on <code>EditStateService</code> to reset <code>EditFields</code>.</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">OnInitializedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>EditContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>EditContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Populates the EditField Collection</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">LoadEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Wires up to the EditContext OnFieldChanged event</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>EditContext<span class="token punctuation">.</span>OnFieldChanged <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>FieldChanged<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>EditStateService<span class="token punctuation">.</span>RecordSaved <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>OnSave<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LoadEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetEditFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>EditStateService<span class="token punctuation">.</span>IsDirty<span class="token punctuation">)</span>
        <span class="token function">SetEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Populates EditFields with the initla values from the loaded model</span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">GetEditFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> model <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>EditContext<span class="token punctuation">.</span>Model<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>EditFields<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>model <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> props <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> prop <span class="token keyword">in</span> props<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>CanWrite<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> <span class="token keyword">value</span> <span class="token operator">=</span> prop<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
                EditFields<span class="token punctuation">.</span><span class="token function">AddField</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> prop<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Applies the saved edit state to EditFields</span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> recordtype <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>EditContext<span class="token punctuation">.</span>Model<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">object</span></span> data <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token function">Deserialize</span><span class="token punctuation">(</span>EditStateService<span class="token punctuation">.</span>Data<span class="token punctuation">,</span> recordtype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> props <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> property <span class="token keyword">in</span> props<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> <span class="token keyword">value</span> <span class="token operator">=</span> property<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            EditFields<span class="token punctuation">.</span><span class="token function">SetField</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">SetModelToEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>EditFields<span class="token punctuation">.</span>IsDirty<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>EditStateChanged<span class="token punctuation">.</span><span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Sets the Model values to the saved edit state values</span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetModelToEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> model <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>EditContext<span class="token punctuation">.</span>Model<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> props <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> property <span class="token keyword">in</span> props<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> <span class="token keyword">value</span> <span class="token operator">=</span> EditFields<span class="token punctuation">.</span><span class="token function">GetEditValue</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>CanWrite<span class="token punctuation">)</span>
            property<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>EditFormState.FieldChanged</code> is triggered by a input change:</p> <ol><li>Reads the current <code>IsDirty</code>.</li> <li>Gets the property and new value from the <code>FieldChangedEventArgs</code>.</li> <li>Sets the <code>EditField</code> in the <code>EditFieldCollection</code>.</li> <li>Checks if the Edit State has changed and if so invokes the <code>EditStateChanged</code> event.</li> <li>Updates the <code>EditStateService</code> edit state.  Either updates it if the edit state is dirty or clears it if the edit state is clean.</li> <li>Sets/resets the <code>PageExitCheck</code> - more later.</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">FieldChanged</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">FieldChangedEventArgs</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> isDirty <span class="token operator">=</span> EditFields<span class="token punctuation">?.</span>IsDirty <span class="token operator">??</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// Get the PropertyInfo object for the model property</span>
    <span class="token comment">// Uses reflection to get property and value</span>
    <span class="token class-name"><span class="token keyword">var</span></span> prop <span class="token operator">=</span> e<span class="token punctuation">.</span>FieldIdentifier<span class="token punctuation">.</span>Model<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>FieldIdentifier<span class="token punctuation">.</span>FieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prop <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Get the value for the property</span>
        <span class="token class-name"><span class="token keyword">var</span></span> <span class="token keyword">value</span> <span class="token operator">=</span> prop<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>FieldIdentifier<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Sets the edit value in the EditField</span>
        EditFields<span class="token punctuation">.</span><span class="token function">SetField</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>FieldIdentifier<span class="token punctuation">.</span>FieldName<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Invokes EditStateChanged if changed</span>
        <span class="token class-name"><span class="token keyword">var</span></span> stateChange <span class="token operator">=</span> <span class="token punctuation">(</span>EditFields<span class="token punctuation">?.</span>IsDirty <span class="token operator">??</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">!=</span> isDirty<span class="token punctuation">;</span>
        isDirty <span class="token operator">=</span> EditFields<span class="token punctuation">?.</span>IsDirty <span class="token operator">??</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stateChange<span class="token punctuation">)</span>
            <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>EditStateChanged<span class="token punctuation">.</span><span class="token function">InvokeAsync</span><span class="token punctuation">(</span>isDirty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isDirty<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">SaveEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ClearEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SaveEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">SetPageExitCheck</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> jsonData <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>EditContext<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    EditStateService<span class="token punctuation">.</span><span class="token function">SetEditState</span><span class="token punctuation">(</span>jsonData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ClearEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">SetPageExitCheck</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    EditStateService<span class="token punctuation">.</span><span class="token function">ClearEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetPageExitCheck</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">bool</span></span> action<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> _js<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">InvokeAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;cecblazor_setEditorExitCheck&quot;</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><ol><li><code>OnSave</code> clears the current edit state and reloads <code>EditFields</code> from the update <code>model</code>.</li> <li><code>NotifyEditStateChanged</code> notifies <code>EditStateService</code> that the edit state has changed.  This raises the <code>EditStateChanged</code> event.</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnSave</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ClearEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">LoadEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifyEditStateChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> isDirty <span class="token operator">=</span> EditFields<span class="token punctuation">?.</span>IsDirty <span class="token operator">??</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>EditStateService<span class="token punctuation">.</span><span class="token function">NotifyEditStateChanged</span><span class="token punctuation">(</span>isDirty<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="extra-site-navigation"><a href="#extra-site-navigation" class="header-anchor">#</a> Extra Site Navigation</h3> <p>This occurs when the user tries to leave the site - closing the browser tab, or clicking on a favourite.  There is no way to stop this directly in Blazor - there's no raised event to link into.  However, the browser does have an event <code>beforeunload</code>.  You don't have much control over it, but you can tell the browser to ask the user if they wish to exit the page.</p> <p><em>site.js</em> defines two functions for adding/removing the event from the browser <code>window</code> object.</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">cecblazor_setEditorExitCheck</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">show</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>show<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;beforeunload&quot;</span><span class="token punctuation">,</span> cecblazor_showExitDialog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;beforeunload&quot;</span><span class="token punctuation">,</span> cecblazor_showExitDialog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

window<span class="token punctuation">.</span><span class="token function-variable function">cecblazor_showExitDialog</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>returnValue <span class="token operator">=</span> <span class="token string">&quot;There are unsaved changes on this page.  Do you want to leave?&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This can then be called from Blazor:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Inject</span></span><span class="token punctuation">]</span> <span class="token keyword">private</span> <span class="token return-type class-name">IJSRuntime</span> _js <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetPageExitCheck</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">bool</span></span> action<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> _js<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">InvokeAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;cecblazor_setEditorExitCheck&quot;</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><code>SetPageExitCheck</code> is used in setting and clearing the edit state in <code>EditFormState</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SaveEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">SetPageExitCheck</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> jsonData <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>EditContext<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    EditStateService<span class="token punctuation">.</span><span class="token function">SetEditState</span><span class="token punctuation">(</span>jsonData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ClearEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">SetPageExitCheck</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    EditStateService<span class="token punctuation">.</span><span class="token function">ClearEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>and in <code>WeatherEditor</code> to clear the edit state on exitting the form.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>EditStateService<span class="token punctuation">.</span><span class="token function">ResetEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">SetPageExitCheck</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    NavManager<span class="token punctuation">.</span><span class="token function">NavigateTo</span><span class="token punctuation">(</span><span class="token string">&quot;/fetchdata&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="intra-site-navigation"><a href="#intra-site-navigation" class="header-anchor">#</a> Intra Site Navigation</h3> <p>Intra site navigation is handled by the <code>Router</code> defined in <code>App</code>.  The actual rendering is handled by <code>RouteView</code>.  This is a simpler component to modify than the router.  Our revised process for <code>RouteView</code> looks like this:</p> <p><img src="/siteimages/Articles/edit-forms/RouteViewManager.png" alt="RouteViewManager"></p> <h3 id="routeviewmanager"><a href="#routeviewmanager" class="header-anchor">#</a> RouteViewManager</h3> <p><code>RouteViewManager</code> is based on <code>RouteView</code>.  It contains code for handling View Management which isn't shown here.</p> <p>The key sections for loading are:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RouteViewManager</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IComponent</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">bool</span></span> _RenderEventQueued<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">RenderHandle</span> _renderHandle<span class="token punctuation">;</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Inject</span></span><span class="token punctuation">]</span> <span class="token keyword">private</span> <span class="token return-type class-name">EditStateService</span> EditStateService <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Inject</span></span><span class="token punctuation">]</span> <span class="token keyword">private</span> <span class="token return-type class-name">IJSRuntime</span> _js <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Inject</span></span><span class="token punctuation">]</span> <span class="token keyword">private</span> <span class="token return-type class-name">NavigationManager</span> NavManager <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Inject</span></span><span class="token punctuation">]</span> <span class="token keyword">private</span> <span class="token return-type class-name">RouteViewService</span> RouteViewService <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Parameter</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name">RouteData</span> RouteData <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Parameter</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name">Type</span> DefaultLayout <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">//... RouteView Code</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Attach</span><span class="token punctuation">(</span><span class="token class-name">RenderHandle</span> renderHandle<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> _renderHandle <span class="token operator">=</span> renderHandle<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SetParametersAsync</span><span class="token punctuation">(</span><span class="token class-name">ParameterView</span> parameters<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Sets the component parameters</span>
            parameters<span class="token punctuation">.</span><span class="token function">SetParameterProperties</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Check if we have either RouteData or ViewData</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>RouteData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;The </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token keyword">nameof</span><span class="token punctuation">(</span>RouteView<span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string"> component requires a non-null value for the parameter </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token keyword">nameof</span><span class="token punctuation">(</span>RouteData<span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">.&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// we've routed and need to clear the ViewData</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_ViewData <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// Render the component</span>
            <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">RenderAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//...  Load Route View Code</span>

        <span class="token keyword">private</span> <span class="token return-type class-name">RenderFragment</span> _renderDelegate <span class="token operator">=&gt;</span> builder <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            _RenderEventQueued <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// Adds cascadingvalue for the ViewManager</span>
            builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">OpenComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CascadingValue<span class="token punctuation">&lt;</span>RouteViewManager<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">AddAttribute</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;Value&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Get the layout render fragment</span>
            builder<span class="token punctuation">.</span><span class="token function">AddAttribute</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;ChildContent&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_layoutViewFragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">CloseComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token return-type class-name">RenderFragment</span> _layoutViewFragment <span class="token operator">=&gt;</span> builder <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">Type</span> _pageLayoutType <span class="token operator">=</span> RouteData<span class="token punctuation">?.</span>PageType<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetCustomAttribute</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>LayoutAttribute<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">?.</span>LayoutType
                <span class="token operator">??</span> RouteViewService<span class="token punctuation">.</span>Layout
                <span class="token operator">??</span> DefaultLayout<span class="token punctuation">;</span>

            builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">OpenComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>LayoutView<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">AddAttribute</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>LayoutView<span class="token punctuation">.</span>Layout<span class="token punctuation">)</span><span class="token punctuation">,</span> _pageLayoutType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>EditStateService<span class="token punctuation">.</span>IsDirty <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>EditStateService<span class="token punctuation">.</span>DoFormReload <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token class-name">true</span><span class="token punctuation">)</span>
                builder<span class="token punctuation">.</span><span class="token function">AddAttribute</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>LayoutView<span class="token punctuation">.</span>ChildContent<span class="token punctuation">)</span><span class="token punctuation">,</span> _dirtyExitFragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>EditStateService<span class="token punctuation">.</span>DoFormReload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                builder<span class="token punctuation">.</span><span class="token function">AddAttribute</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>LayoutView<span class="token punctuation">.</span>ChildContent<span class="token punctuation">)</span><span class="token punctuation">,</span> _renderComponentWithParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            builder<span class="token punctuation">.</span><span class="token function">CloseComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token return-type class-name">RenderFragment</span> _dirtyExitFragment <span class="token operator">=&gt;</span> builder <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">OpenElement</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">AddAttribute</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dirty-exit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">{</span>
                builder<span class="token punctuation">.</span><span class="token function">OpenElement</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                builder<span class="token punctuation">.</span><span class="token function">AddAttribute</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dirty-exit-message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                builder<span class="token punctuation">.</span><span class="token function">AddContent</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">&quot;You are existing a form with unsaved data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                builder<span class="token punctuation">.</span><span class="token function">CloseElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">{</span>
                builder<span class="token punctuation">.</span><span class="token function">OpenElement</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                builder<span class="token punctuation">.</span><span class="token function">AddAttribute</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dirty-exit-message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">{</span>
                    builder<span class="token punctuation">.</span><span class="token function">OpenElement</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;button&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    builder<span class="token punctuation">.</span><span class="token function">AddAttribute</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dirty-exit-button&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    builder<span class="token punctuation">.</span><span class="token function">AddAttribute</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">&quot;onclick&quot;</span><span class="token punctuation">,</span> EventCallback<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Create</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MouseEventArgs<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DirtyExit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    builder<span class="token punctuation">.</span><span class="token function">AddContent</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">&quot;Exit and Clear Unsaved Data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    builder<span class="token punctuation">.</span><span class="token function">CloseElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">{</span>
                    builder<span class="token punctuation">.</span><span class="token function">OpenElement</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;button&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    builder<span class="token punctuation">.</span><span class="token function">AddAttribute</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;load-dirty-form-button&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    builder<span class="token punctuation">.</span><span class="token function">AddAttribute</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">&quot;onclick&quot;</span><span class="token punctuation">,</span> EventCallback<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Create</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MouseEventArgs<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>LoadDirtyForm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    builder<span class="token punctuation">.</span><span class="token function">AddContent</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">&quot;Reload Form&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    builder<span class="token punctuation">.</span><span class="token function">CloseElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                builder<span class="token punctuation">.</span><span class="token function">CloseElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            builder<span class="token punctuation">.</span><span class="token function">CloseElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token return-type class-name">RenderFragment</span> _renderComponentWithParameters <span class="token operator">=&gt;</span> builder <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">Type</span> componentType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">IReadOnlyDictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>_ViewData <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                componentType <span class="token operator">=</span> _ViewData<span class="token punctuation">.</span>ViewType<span class="token punctuation">;</span>
                parameters <span class="token operator">=</span> _ViewData<span class="token punctuation">.</span>ViewParameters<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>RouteData <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                componentType <span class="token operator">=</span> RouteData<span class="token punctuation">.</span>PageType<span class="token punctuation">;</span>
                parameters <span class="token operator">=</span> RouteData<span class="token punctuation">.</span>RouteValues<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>componentType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                builder<span class="token punctuation">.</span><span class="token function">OpenComponent</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> componentType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> kvp <span class="token keyword">in</span> parameters<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    builder<span class="token punctuation">.</span><span class="token function">AddAttribute</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> kvp<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> kvp<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                builder<span class="token punctuation">.</span><span class="token function">CloseComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                builder<span class="token punctuation">.</span><span class="token function">OpenElement</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                builder<span class="token punctuation">.</span><span class="token function">AddContent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;No Route or View Configured to Display&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                builder<span class="token punctuation">.</span><span class="token function">CloseElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RenderAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_RenderEventQueued<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_RenderEventQueued <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                _renderHandle<span class="token punctuation">.</span><span class="token function">Render</span><span class="token punctuation">(</span>_renderDelegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">protected</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">Action</span> workItem<span class="token punctuation">)</span> 
            <span class="token operator">=&gt;</span> _renderHandle<span class="token punctuation">.</span>Dispatcher<span class="token punctuation">.</span><span class="token function">InvokeAsync</span><span class="token punctuation">(</span>workItem<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">protected</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">Func<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&gt;</span></span> workItem<span class="token punctuation">)</span> 
            <span class="token operator">=&gt;</span> _renderHandle<span class="token punctuation">.</span>Dispatcher<span class="token punctuation">.</span><span class="token function">InvokeAsync</span><span class="token punctuation">(</span>workItem<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token return-type class-name">Task</span> <span class="token function">DirtyExit</span><span class="token punctuation">(</span><span class="token class-name">MouseEventArgs</span> d<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>EditStateService<span class="token punctuation">.</span><span class="token function">ClearEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">SetPageExitCheck</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">RenderAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LoadDirtyForm</span><span class="token punctuation">(</span><span class="token class-name">MouseEventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>EditStateService<span class="token punctuation">.</span>DoFormReload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            NavManager<span class="token punctuation">.</span><span class="token function">NavigateTo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>EditStateService<span class="token punctuation">.</span>EditFormUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetPageExitCheck</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">bool</span></span> action<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> _js<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">InvokeAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;cecblazor_setEditorExitCheck&quot;</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>The component has two button event handlers to handle the two Dirty Form options</p> <ol><li><code>DirtyExit</code></li> <li><code>LoadDirtyForm</code></li></ol> <p>and <code>SetPageExitCheck</code> to set the browser page exit event.</p> <p>The RenderFragement code builds out the layout which adds either <code>_dirtyExitFragment</code> to build the Dirty Exit view or <code>_renderComponentWithParameters</code> to build out the route/view component.</p> <h2 id="the-solution-in-action"><a href="#the-solution-in-action" class="header-anchor">#</a> The Solution in Action</h2> <p>You can see the solution in action at <a href="https://cec-blazor-server.azurewebsites.net/" target="_blank" rel="noopener noreferrer">https://cec-blazor-database.azurewebsites.net/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Run the solution go to <strong>FetchData</strong> and click on Edit a record.  You will see:</p> <p><img src="/siteimages/Articles/edit-forms/Clean-Editor.png" alt="Clean Editor"></p> <p>Save/Update disabled, normal Exit and you can go where you want.</p> <p>Now Change the Temperature, and you will see:</p> <p><img src="/siteimages/Articles/edit-forms/Dirty-Editor.png" alt="Dirty Editor"></p> <p>Now Save is enabled and the Exit button has changed.</p> <p>Click on a menu link, or hit the browser back button:</p> <p><img src="/siteimages/Articles/edit-forms/Dirty-Exit.png" alt="Dirty Editor"></p> <p>You now get the Dirty Exit Challenge from <code>RouteViewManager</code>.  Check what happens on each action.</p> <p>Finally hit F5 to reload the page.</p> <p><img src="/siteimages/Articles/edit-forms/Dirty-App-Exit.png" alt="Dirty Editor"></p> <p>This time you get the browser challenge - the text depends on the specific browser - they all implement the challenge slightly differently.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      
      <a href="/articles/Blazor-Components.html" class="prev">
        A Deep Dive into Blazor Components
      </a></span> <span class="next"><a href="/articles/EditFormState.html">
        The Blazor EditFormState Control
      </a>
      
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.a728ba5d.js" defer></script><script src="/assets/js/3.3d8b86b8.js" defer></script><script src="/assets/js/49.6869f1c2.js" defer></script>
  </body>
</html>
