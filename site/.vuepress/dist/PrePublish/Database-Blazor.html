<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Building a Blazor Database Pipeline | Cold Elm Coders</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.44eeee96.css" as="style"><link rel="preload" href="/assets/js/app.a728ba5d.js" as="script"><link rel="preload" href="/assets/js/3.3d8b86b8.js" as="script"><link rel="preload" href="/assets/js/31.4fa00807.js" as="script"><link rel="prefetch" href="/assets/js/1.3b0fc1ec.js"><link rel="prefetch" href="/assets/js/10.a274dc46.js"><link rel="prefetch" href="/assets/js/11.162f7736.js"><link rel="prefetch" href="/assets/js/12.9b137fad.js"><link rel="prefetch" href="/assets/js/13.b0705d6f.js"><link rel="prefetch" href="/assets/js/14.90a14690.js"><link rel="prefetch" href="/assets/js/15.7d24e989.js"><link rel="prefetch" href="/assets/js/16.3321fd05.js"><link rel="prefetch" href="/assets/js/17.2a730ee9.js"><link rel="prefetch" href="/assets/js/18.93009d66.js"><link rel="prefetch" href="/assets/js/19.dd7916e7.js"><link rel="prefetch" href="/assets/js/20.06257388.js"><link rel="prefetch" href="/assets/js/21.ad06fee8.js"><link rel="prefetch" href="/assets/js/22.57c9e301.js"><link rel="prefetch" href="/assets/js/23.8c523222.js"><link rel="prefetch" href="/assets/js/24.c3de66a9.js"><link rel="prefetch" href="/assets/js/25.bb1f5210.js"><link rel="prefetch" href="/assets/js/26.1e04e64c.js"><link rel="prefetch" href="/assets/js/27.a24ae7a8.js"><link rel="prefetch" href="/assets/js/28.3cc80874.js"><link rel="prefetch" href="/assets/js/29.92a16acf.js"><link rel="prefetch" href="/assets/js/30.ba76c29c.js"><link rel="prefetch" href="/assets/js/32.f6618632.js"><link rel="prefetch" href="/assets/js/33.4dc1d2a9.js"><link rel="prefetch" href="/assets/js/34.266d295c.js"><link rel="prefetch" href="/assets/js/35.03c4dbda.js"><link rel="prefetch" href="/assets/js/36.cfb72d79.js"><link rel="prefetch" href="/assets/js/37.44581004.js"><link rel="prefetch" href="/assets/js/38.b49cb2d8.js"><link rel="prefetch" href="/assets/js/39.a96a4623.js"><link rel="prefetch" href="/assets/js/4.0476436c.js"><link rel="prefetch" href="/assets/js/40.47e33d12.js"><link rel="prefetch" href="/assets/js/41.96a37d4b.js"><link rel="prefetch" href="/assets/js/42.48f1e665.js"><link rel="prefetch" href="/assets/js/43.008951cc.js"><link rel="prefetch" href="/assets/js/44.b3b98e4c.js"><link rel="prefetch" href="/assets/js/45.d83537f4.js"><link rel="prefetch" href="/assets/js/46.78680b50.js"><link rel="prefetch" href="/assets/js/47.12a37bbb.js"><link rel="prefetch" href="/assets/js/48.2c8d0d86.js"><link rel="prefetch" href="/assets/js/49.6869f1c2.js"><link rel="prefetch" href="/assets/js/5.c21f6997.js"><link rel="prefetch" href="/assets/js/50.ec126d1b.js"><link rel="prefetch" href="/assets/js/51.35e75015.js"><link rel="prefetch" href="/assets/js/52.1a18ae8f.js"><link rel="prefetch" href="/assets/js/53.ab8d3568.js"><link rel="prefetch" href="/assets/js/54.27cea7d8.js"><link rel="prefetch" href="/assets/js/55.8a049d96.js"><link rel="prefetch" href="/assets/js/56.4224eefd.js"><link rel="prefetch" href="/assets/js/57.0714983c.js"><link rel="prefetch" href="/assets/js/58.dcaa0649.js"><link rel="prefetch" href="/assets/js/59.a8f404ff.js"><link rel="prefetch" href="/assets/js/6.c00c814d.js"><link rel="prefetch" href="/assets/js/60.041dbde1.js"><link rel="prefetch" href="/assets/js/61.96a9eef9.js"><link rel="prefetch" href="/assets/js/62.20def6a6.js"><link rel="prefetch" href="/assets/js/63.c58c947f.js"><link rel="prefetch" href="/assets/js/64.bc57bfde.js"><link rel="prefetch" href="/assets/js/65.654f70a6.js"><link rel="prefetch" href="/assets/js/7.c2996796.js"><link rel="prefetch" href="/assets/js/8.a4f8ac88.js"><link rel="prefetch" href="/assets/js/9.62cada5e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.44eeee96.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Cold Elm Coders</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/articles/" class="nav-link">
  Articles
</a></div><div class="nav-item"><a href="/posts/" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="/ArchivedArticles/" class="nav-link">
  Old Articles
</a></div><div class="nav-item"><a href="/Building-a-Database-Application-in-Blazor/" class="nav-link">
  Database Application
</a></div><div class="nav-item"><a href="https://cec-blazor-examples.azurewebsites.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Demo Site
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/articles/" class="nav-link">
  Articles
</a></div><div class="nav-item"><a href="/posts/" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="/ArchivedArticles/" class="nav-link">
  Old Articles
</a></div><div class="nav-item"><a href="/Building-a-Database-Application-in-Blazor/" class="nav-link">
  Database Application
</a></div><div class="nav-item"><a href="https://cec-blazor-examples.azurewebsites.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Demo Site
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/articles/" class="sidebar-link">Articles</a></li><li><a href="/archivedarticles/" class="sidebar-link">Articles</a></li><li><a href="/posts/" class="sidebar-link">Posts</a></li><li><a href="/Building-a-Database-Application-in-Blazor/" class="sidebar-link">Building a Database Application in Blazor</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="building-a-blazor-database-pipeline"><a href="#building-a-blazor-database-pipeline" class="header-anchor">#</a> Building a Blazor Database Pipeline</h1> <p>Publish Date: 2021-06-04
Last Updated: 2021-06-04</p> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>This article describes how to develop a framework for working with databases in Blazor. It looks at how to build a generic, abstract code base  for the data pipeline using patterns, generics and conventions.  The article uses the out-of-the-box Blazor template WeatherForecast dataset to demonstrate the principles and methodologies used.</p> <h2 id="initial-setup"><a href="#initial-setup" class="header-anchor">#</a> Initial Setup</h2> <p>The starting point for this project is <em>Blazor.App</em>.  It's a Github repository containing a version of the out-of-the-box Blazor template configured to run in both Server and WASM modes.</p> <p>I won't go into detail on how it's configured, but there are two projects:</p> <ol><li><em>Blazor.App</em> is a Blazor WASM project.  It provides the library code for both the WASM and Server SPAs, along with the Web Assembly startup code for the WASM SPA.</li> <li><em>Blazor.Web</em> is the web server for both the Server and WASM SPA entry points.  It provides the Blazor Server Hub services and the WASM API controllers.</li></ol> <p><em>Blazor.Web</em> starts the Blazor Server Application.  There's a menu option to switch to the Blazor WASM SPA.  Each uses a different colour template, so you can see which SPA you are in.</p> <p>Take the solution and rename it <em>Blazor.Db</em>, changing the root folder name and the solution file name.  We'll keep the two projects as is.  You're free to rename them as you wish.</p> <h2 id="application"><a href="#application" class="header-anchor">#</a> Application</h2> <p>The basic application design looks like this.</p> <p><img src="/siteimages/articles/blazor-db/basic-design.png" alt="Basic Application Design"></p> <p>We separate our code into three units with clearly defined interfaces between the units.  This article covers the <em>Data Layer</em> and the <em>Core Application</em>.</p> <h2 id="data"><a href="#data" class="header-anchor">#</a> Data</h2> <p>The diagram below shows the design detail.</p> <p><img src="/siteimages/articles/blazor-db/Data-Application-Detail.png" alt="Data Application Detail"></p> <h3 id="interfaces"><a href="#interfaces" class="header-anchor">#</a> Interfaces</h3> <p>To develop generic code we need to define and use a set of interfaces that define the key properties and methods.</p> <h3 id="idbrecord"><a href="#idbrecord" class="header-anchor">#</a> IDbRecord</h3> <p>Add an <em>Interfaces</em> folder to <em>Data</em> in <em>Blazor.App</em> and add a new interface <em>IDbRecord.cs</em>.  This is the common interface implemented by all our model data classes.</p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDbRecord<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> 
    <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/// ID for the Table</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> GUID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// Default Field to use to display the record in the UI</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> DisplayName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// Method to get the EF DbSet name for the database</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetDbSetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li><code>GUID</code> is the key identity field for all the records.</li> <li><code>DisplayName</code> provides a common Name property used throughout the application.</li> <li><code>GetDbSetName</code> is a method to get/define the <code>DbSet</code> name used by the Entity Framework DBContext.  By default it returns the class name, but it can be defined in a model class to use a differnet name.  <code>WeatherForecast</code> does just that because we're using plural table names (for demo purposes).</li></ol> <h3 id="refactor-weatherforecast"><a href="#refactor-weatherforecast" class="header-anchor">#</a> Refactor WeatherForecast</h3> <p>Update <code>WeatherForecast</code> as shown below.  Create a folder in <em>Data</em> called <em>ModelClasses</em> and move <code>WeatherForcast</code> into it.</p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token class-name">record</span> WeatherForecast <span class="token punctuation">:</span> IDbRecord<span class="token operator">&lt;</span>WeatherForecast<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Key</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> GUID <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span> init<span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTimeOffset</span> Date <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> init<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> TemperatureC <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> init<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NotMapped</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> TemperatureF 
        <span class="token operator">=&gt;</span> <span class="token number">32</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>TemperatureC <span class="token operator">/</span> <span class="token number">0.5556</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Summary <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> init<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NotMapped</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> DisplayName 
        <span class="token operator">=&gt;</span> <span class="token interpolation-string"><span class="token string">$&quot;Weather Forecast for </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token keyword">this</span><span class="token punctuation">.</span>Date<span class="token punctuation">.</span><span class="token function">ToShortDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetDbSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token string">&quot;WeatherForecasts&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>Now defined as a <code>record</code> to make it immutable with <code>init</code> setters.</li> <li>Implements the <code>IDbRecord</code> interface.</li> <li>Has a <code>Guid</code> identity property marked with <code>[key]</code>.</li> <li>Date is now of type <code>DataTimeOffset</code> - the proper way to do date/time.</li> <li><code>TemperatureF</code> and <code>DisplayName</code> are marked as <code>[NotMapped]</code> so EF doesn't attempt to retrieve them from the table.</li> <li><code>DisplayName</code> setter building the record name.</li> <li><code>GetDbSet</code> returning <em>WeatherForecasts</em> as the <code>DbSet</code> name will be different from the class name.</li></ol> <h2 id="data-layer"><a href="#data-layer" class="header-anchor">#</a> Data Layer</h2> <h2 id="add-dependancies"><a href="#add-dependancies" class="header-anchor">#</a> Add Dependancies</h2> <p>Add the following dependencies to the project:</p> <div class="language-xml extra-class"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Microsoft.EntityFrameworkCore<span class="token punctuation">&quot;</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>5.0.5<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Microsoft.EntityFrameworkCore.Sqlite<span class="token punctuation">&quot;</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>5.0.5<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><h3 id="add-a-dbcontext"><a href="#add-a-dbcontext" class="header-anchor">#</a> Add a DbContext</h3> <p>Add a <em>DbContexts</em> folder to <em>Data</em> and add a new class <em>InMemoryWeatherDbContext.cs</em>.</p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InMemoryWeatherDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
 <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> WeatherForecast <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">InMemoryWeatherDbContext</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptions<span class="token punctuation">&lt;</span>InMemoryWeatherDbContext<span class="token punctuation">&gt;</span></span> options<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">BuildInMemoryDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BuildInMemoryDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> conn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">GetDbConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> cmd <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">CreateCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cmd<span class="token punctuation">.</span>CommandText <span class="token operator">=</span> <span class="token string">&quot;CREATE TABLE [WeatherForecasts]([ID] UNIQUEIDENTIFIER PRIMARY KEY, [Date] [smalldatetime] NOT NULL, [TemperatureC] [int] NOT NULL, [Summary] [varchar](255) NULL)&quot;</span><span class="token punctuation">;</span>
        cmd<span class="token punctuation">.</span><span class="token function">ExecuteNonQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> forecast <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>NewForecasts<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            cmd<span class="token punctuation">.</span>CommandText <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;INSERT INTO WeatherForecasts([ID] ,[Date], [TemperatureC], [Summary]) VALUES('</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">forecast<span class="token punctuation">.</span>GUID</span><span class="token punctuation">}</span></span><span class="token string">', '</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">forecast<span class="token punctuation">.</span>Date<span class="token punctuation">.</span>LocalDateTime<span class="token punctuation">.</span><span class="token function">ToLongDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">', </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">forecast<span class="token punctuation">.</span>TemperatureC</span><span class="token punctuation">}</span></span><span class="token string">, '</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">forecast<span class="token punctuation">.</span>Summary</span><span class="token punctuation">}</span></span><span class="token string">')&quot;</span></span><span class="token punctuation">;</span>
            cmd<span class="token punctuation">.</span><span class="token function">ExecuteNonQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> Summaries <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;Freezing&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bracing&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Chilly&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Cool&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mild&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Warm&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Balmy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Hot&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Sweltering&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Scorching&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> NewForecasts
    <span class="token punctuation">{</span>
        <span class="token keyword">get</span>
        <span class="token punctuation">{</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Enumerable<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>index <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WeatherForecast</span>
                <span class="token punctuation">{</span>
                    GUID <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Date <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    TemperatureC <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Summary <span class="token operator">=</span> Summaries<span class="token punctuation">[</span>rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>Summaries<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>Defines one <code>DbSet</code> for <code>WeatherForecasts</code>.</li> <li>Defines methods and properties to build the database when the <code>DbContext</code> is created. We get an empty SQLite database instance whenever the context is initialised so we need to populate it.</li></ol> <p>The final piece of the data layer is the external interface for our Core Application Layer to use.  This is a <code>Broker</code>.  In our case a data broker to provide basic CRUD and list functionality.  Brokers are often referred to as a <em>shim</em> - a thin translation layer.</p> <h4 id="dbcontextextensions"><a href="#dbcontextextensions" class="header-anchor">#</a> DbContextExtensions</h4> <p>This is an extension class for <code>DbContext</code>.  The single method gets a <code>DbSet</code> based on the provided <code>TRecord</code>.  This method gets the <code>DbSet</code> object for the specified <code>TRecord</code>.</p> <p>If <code>TRecord</code> is <code>WeatherForecast</code>, the <code>dbSetName</code> is <em>WeatherForecasts</em>.  This method uses reflection to get the <code>WeatherForecasts</code> object from the current <code>DbContext</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DbContextExtensions</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">DbContext</span> context<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> dbSetName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDbSetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> pinfo <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span>dbSetName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DbSet<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> dbSet <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                dbSet <span class="token operator">=</span> <span class="token punctuation">(</span>DbSet<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">)</span>pinfo<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">dbSetName</span><span class="token punctuation">}</span></span><span class="token string"> does not have a matching DBset &quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>dbSet <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> dbSet<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="data-brokers"><a href="#data-brokers" class="header-anchor">#</a> Data Brokers</h3> <p>Brokers are always accessed though interfaces.</p> <h4 id="idatabroker"><a href="#idatabroker" class="header-anchor">#</a> IDataBroker</h4> <p>Note that generics are applied to the methods not the interface.  We define <code>TRecord</code> must be a class, implement <code>IDbRecord</code> and have a <code>new</code> with no arguments.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDataBroker</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SelectAllRecordsAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SelectRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Guid</span> id<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SelectRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">InsertRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="basedatabroker"><a href="#basedatabroker" class="header-anchor">#</a> BaseDataBroker</h4> <p><code>BaseDataBroker</code> is a base abstract class to implement this interface. it doesn't do a lot except return new records, an empty list and define the constraint conditions on <code>TRecord</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseDataBroker</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDataBroker</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SelectAllRecordsAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> ValueTask<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SelectRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Guid</span> id<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> ValueTask<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SelectRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> ValueTask<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> ValueTask<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">InsertRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> ValueTask<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> ValueTask<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="inmemorydatabroker"><a href="#inmemorydatabroker" class="header-anchor">#</a> InMemoryDataBroker</h4> <p>Finally we define the in memory broker for our SQLite database.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InMemoryDataBroker<span class="token punctuation">&lt;</span>TDbContext<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span>
        <span class="token type-list"><span class="token class-name">BaseDataBroker</span><span class="token punctuation">,</span>
        <span class="token class-name">IDataBroker</span></span>
        <span class="token keyword">where</span> <span class="token class-name">TDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
    <span class="token punctuation">{</span>

        <span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IDbContextFactory<span class="token punctuation">&lt;</span>TDbContext<span class="token punctuation">&gt;</span></span> DBContext <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">DbContext</span> _dbContext<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">InMemoryDataBroker</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">IDbContextFactory<span class="token punctuation">&lt;</span>TDbContext<span class="token punctuation">&gt;</span></span> dbContext<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext <span class="token operator">=</span> dbContext<span class="token punctuation">;</span>
            _dbContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SelectAllRecordsAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> dbset<span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SelectRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Guid</span> id<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> dbset<span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">)</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span>GUID <span class="token operator">==</span> id<span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">SelectRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> dbset<span class="token punctuation">.</span><span class="token function">CountAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _dbContext<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> EntityState<span class="token punctuation">.</span>Modified<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> x <span class="token operator">=</span> <span class="token keyword">await</span> _dbContext<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> x <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">InsertRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dbset<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> x <span class="token operator">=</span> <span class="token keyword">await</span> _dbContext<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> x <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _dbContext<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> EntityState<span class="token punctuation">.</span>Deleted<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> x <span class="token operator">=</span> <span class="token keyword">await</span> _dbContext<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> x <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><ol><li>We used generics on a method by method basis and get the DbSet for the <code>TRecord</code> type defined at runtime.</li> <li>Each method uses the <code>GetDbSet</code> extension we declared above to get the correct EF <code>DbSet</code> object and then runs the appropriate <code>DbSet</code> method.</li> <li>In this implementation we use a single DbContext, rather than one per operartion because we are dealing with an in-memory instance. Each DbContext would be a new copy database!</li></ol> <h3 id="comment"><a href="#comment" class="header-anchor">#</a> Comment</h3> <p>At this point we have our data layer black box defined, with an interface to access it.  Why do it this way?  Simple, separate out our core application from the underlying data source.  If we design it right we can switch to pulling the weather forecasts from a provider and only our broker needs will change.  Get it wrong and we have to redesign everything.</p> <h2 id="core-application-code"><a href="#core-application-code" class="header-anchor">#</a> Core Application Code</h2> <p>We move on to defining the core application.</p> <h3 id="connectors"><a href="#connectors" class="header-anchor">#</a> Connectors</h3> <p>Connectors provide the interface between the application code and brokers.  The black box data interface for the application code.</p> <h3 id="idataserviceconnector"><a href="#idataserviceconnector" class="header-anchor">#</a> IDataServiceConnector</h3> <p>This is the interface definition.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDataServiceConnector</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">AddRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TModel</span> model<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TModel</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TModel<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordByIdAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Guid</span> ModelId<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TModel</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TModel<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">ModifyRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TModel</span> model<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TModel</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TModel<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">RemoveRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TModel</span> model<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TModel</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TModel<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TModel</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TModel<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetAllRecordsAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TModel</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TModel<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="modeldataserviceconnector"><a href="#modeldataserviceconnector" class="header-anchor">#</a> ModelDataServiceConnector</h3> <p>The main model connector implements <code>IDataServiceConnector</code>, gets the <code>IDataBroker</code> by dependenct injection, and makes the necessary calls into the broker.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ModelDataServiceConnector</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">IDataServiceConnector</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IDataBroker</span> dataBroker<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">ModelDataServiceConnector</span><span class="token punctuation">(</span><span class="token class-name">IDataBroker</span> dataBroker<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dataBroker <span class="token operator">=</span> dataBroker<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">AddRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TModel</span> model<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TModel</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TModel<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataBroker<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">InsertRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetAllRecordsAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TModel</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TModel<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataBroker<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SelectAllRecordsAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordByIdAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Guid</span> modelId<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TModel</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TModel<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataBroker<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SelectRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>modelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">ModifyRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TModel</span> model<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TModel</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TModel<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataBroker<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">RemoveRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TModel</span> model<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TModel</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TModel<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataBroker<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TModel</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TModel<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataBroker<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SelectRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="viewservices"><a href="#viewservices" class="header-anchor">#</a> ViewServices</h3> <p>The final bit of the data jigsaw are the ViewServices.  These interface directly with the UI.</p> <h3 id="imodelviewservice"><a href="#imodelviewservice" class="header-anchor">#</a> IModelViewService</h3> <p><code>IModelViewService</code> defines the standard interface used for simple model data classes.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IModelViewService<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span>
    <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">TRecord</span> Record <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> Records <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> RecordCount <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsRecord <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> HasRecords <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsNewRecord <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler</span> RecordHasChanged<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler</span> ListHasChanged<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask</span> <span class="token function">ResetServiceAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask</span> <span class="token function">ResetRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask</span> <span class="token function">ResetListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask</span> <span class="token function">GetRecordsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">SaveRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetRecordAsync</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">NewRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">DeleteRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="basemodelviewservice"><a href="#basemodelviewservice" class="header-anchor">#</a> BaseModelViewService</h3> <p><code>BaseModelViewService</code> provides an abstract implementation of ModelViewService.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseModelViewService<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span>
        <span class="token type-list"><span class="token class-name">IDisposable</span><span class="token punctuation">,</span>
        <span class="token class-name">IModelViewService<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span>
        <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">TRecord</span> Record
        <span class="token punctuation">{</span>
            <span class="token keyword">get</span> <span class="token operator">=&gt;</span> _record<span class="token punctuation">;</span>
            <span class="token keyword">private</span> <span class="token keyword">set</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_record <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>RecordHasChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">,</span> EventArgs<span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">private</span> <span class="token class-name">TRecord</span> _record <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> Records
        <span class="token punctuation">{</span>
            <span class="token keyword">get</span> <span class="token operator">=&gt;</span> _records<span class="token punctuation">;</span>
            <span class="token keyword">private</span> <span class="token keyword">set</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_records <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>ListHasChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">,</span> EventArgs<span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">private</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> _records <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsRecord <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Record <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> HasRecords <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Records <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Records<span class="token punctuation">.</span>Count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsNewRecord <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Record <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Record<span class="token punctuation">.</span>GUID <span class="token operator">==</span> Guid<span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token return-type class-name">IDataServiceConnector</span> DataServiceConnector <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> RecordCount <span class="token operator">=&gt;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NotImplementedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler</span> RecordHasChanged<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler</span> ListHasChanged<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">BaseModelViewService</span><span class="token punctuation">(</span><span class="token class-name">IDataServiceConnector</span> dataServiceConnector<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>DataServiceConnector <span class="token operator">=</span> dataServiceConnector<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask</span> <span class="token function">ResetServiceAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ResetListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ResetRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask</span> <span class="token function">ResetListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>Records <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ValueTask<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask</span> <span class="token function">ResetRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>Record <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ValueTask<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask</span> <span class="token function">GetRecordsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>Records <span class="token operator">=</span> <span class="token keyword">await</span> DataServiceConnector<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetAllRecordsAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ListHasChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> EventArgs<span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetRecordAsync</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> id<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">!=</span> Guid<span class="token punctuation">.</span>Empty<span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>Record <span class="token operator">=</span> <span class="token keyword">await</span> DataServiceConnector<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordByIdAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>Record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>IsRecord<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetRecordListCountAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataServiceConnector<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">SaveRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>IsNewRecord<span class="token punctuation">)</span>
                result <span class="token operator">=</span> <span class="token keyword">await</span> DataServiceConnector<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Record<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                result <span class="token operator">=</span> <span class="token keyword">await</span> DataServiceConnector<span class="token punctuation">.</span><span class="token function">ModifyRecordAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Record<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetRecordsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">DeleteRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataServiceConnector<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RemoveRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Record<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnPageChanged</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetRecordsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifyRecordChanged</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>RecordHasChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NotifyListChanged</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ListHasChanged<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">NewRecordAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>Record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ValueTask<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="weatherforecastviewservice"><a href="#weatherforecastviewservice" class="header-anchor">#</a> WeatherForecastViewService</h3> <p><code>WeatherForecastViewService</code> is the implementation of <code>IModelViewService</code> for a <code>WeatherForecast</code>, inheriting from <code>BaseModelViewService</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastViewService</span> <span class="token punctuation">:</span> 
    <span class="token type-list"><span class="token class-name">BaseModelViewService<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> 
    <span class="token class-name">IModelViewService<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">WeatherForecastViewService</span><span class="token punctuation">(</span><span class="token class-name">IDataServiceConnector</span> dataServiceConnector<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>dataServiceConnector<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="configuring-services"><a href="#configuring-services" class="header-anchor">#</a> Configuring Services</h3> <p>Create an <em>Extensions</em> folder and add a class file called <em>ServiceCollectionsExtensions.cs</em>.  This encapsulates all the services defined by the application.  There are two <code>IServiceCollection</code> extension methods.  One for <em>Server</em>, the other for <em>WASM</em>.</p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServiceCollectionExtensions</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">AddInMemoryApplicationServices</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// In Memory DB Setup</span>
            <span class="token class-name"><span class="token keyword">var</span></span> memdbContext <span class="token operator">=</span> <span class="token string">&quot;Data Source=:memory:&quot;</span><span class="token punctuation">;</span>
            services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContextFactory</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>InMemoryWeatherDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span> options<span class="token punctuation">.</span><span class="token function">UseSqlite</span><span class="token punctuation">(</span>memdbContext<span class="token punctuation">)</span><span class="token punctuation">,</span> ServiceLifetime<span class="token punctuation">.</span>Singleton<span class="token punctuation">)</span><span class="token punctuation">;</span>
            services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDataBroker<span class="token punctuation">,</span> InMemoryDataBroker<span class="token punctuation">&lt;</span>InMemoryWeatherDbContext<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">AddCommonServices</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> services<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">AddAPIApplicationServices</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDataBroker<span class="token punctuation">,</span> APIDataBroker<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">AddCommonServices</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> services<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddCommonServices</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDataServiceConnector<span class="token punctuation">,</span> ModelDataServiceConnector<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecastViewService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><ol><li>Defined as <code>static</code>, it only contains extension methods.</li> <li>Defines <code>AddInMemoryApplicationServices</code> which contains all the Server specific services.</li> <li>Defines <code>AddAPIApplicationServices</code> which contains all the WASM specific services.</li> <li>Defines a DbContextFactory to build instances of <code>AddInMemoryApplicationServices</code>.</li> <li>Defines a <code>AddCommonServices</code> method which contains all the services common to both WASM and Server versions.</li></ol> <p>Add <code>AddInMemoryApplicationServices</code> to <code>Startup.cs</code> in <em>Blazor.Web</em>:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddRazorPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddServerSideBlazor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddInMemoryApplicationServices</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Add <code>AddAPIApplicationServices</code> to <code>Program.cs</code> in <em>Blazor.App</em>:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebAssemblyHostBuilder<span class="token punctuation">.</span><span class="token function">CreateDefault</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span>RootComponents<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Add</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>App<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddScoped</span><span class="token punctuation">(</span>sp <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpClient</span> <span class="token punctuation">{</span> BaseAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>HostEnvironment<span class="token punctuation">.</span>BaseAddress<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAPIApplicationServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ui"><a href="#ui" class="header-anchor">#</a> UI</h2> <p>We will look at building a UI Framework in another article.  For now we'll adapt <code>FetchData</code> to use our new Data pipeline.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>@page <span class="token string">&quot;/fetchdata&quot;</span>
<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Weather Forecasts<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>This component demonstrates fetching data <span class="token keyword">from</span> a service<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
@<span class="token keyword">if</span> <span class="token punctuation">(</span>ViewService<span class="token punctuation">.</span>Records <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>em<span class="token operator">&gt;</span>Loading<span class="token range operator">..</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>em<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{</span>
    <span class="token operator">&lt;</span>table <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;table&quot;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>thead<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>tr<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>th<span class="token operator">&gt;</span>Date<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>th<span class="token operator">&gt;</span>Temp<span class="token punctuation">.</span> <span class="token punctuation">(</span>C<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>th<span class="token operator">&gt;</span>Temp<span class="token punctuation">.</span> <span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>th<span class="token operator">&gt;</span>Summary<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>thead<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>tbody<span class="token operator">&gt;</span>
            @<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> forecast <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ViewService<span class="token punctuation">.</span>Records<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token operator">&lt;</span>tr<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span>@forecast<span class="token punctuation">.</span>Date<span class="token punctuation">.</span>LocalDateTime<span class="token punctuation">.</span><span class="token function">ToShortDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span>@forecast<span class="token punctuation">.</span>TemperatureC<span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span>@forecast<span class="token punctuation">.</span>TemperatureF<span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span>@forecast<span class="token punctuation">.</span>Summary<span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
            <span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>tbody<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

@code <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Inject</span></span><span class="token punctuation">]</span> <span class="token keyword">private</span> <span class="token return-type class-name">WeatherForecastViewService</span> ViewService <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">OnInitializedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> ViewService<span class="token punctuation">.</span><span class="token function">GetRecordsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnInitializedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>We've injected the View Service.</li> <li>We've fetxched the Records in <code>OnInitializedAsync</code>.</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.a728ba5d.js" defer></script><script src="/assets/js/3.3d8b86b8.js" defer></script><script src="/assets/js/31.4fa00807.js" defer></script>
  </body>
</html>
