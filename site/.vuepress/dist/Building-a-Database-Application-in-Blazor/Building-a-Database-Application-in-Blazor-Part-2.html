<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Part 2 - Services - Building the CRUD Data Layers | Cold Elm Coders</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.dd68a41e.css" as="style"><link rel="preload" href="/assets/js/app.0784ea42.js" as="script"><link rel="preload" href="/assets/js/3.36dc20da.js" as="script"><link rel="preload" href="/assets/js/13.3853eda2.js" as="script"><link rel="prefetch" href="/assets/js/10.b9150889.js"><link rel="prefetch" href="/assets/js/11.e135ddc5.js"><link rel="prefetch" href="/assets/js/12.f7a15c90.js"><link rel="prefetch" href="/assets/js/14.0e4ef0bd.js"><link rel="prefetch" href="/assets/js/15.2319b6a1.js"><link rel="prefetch" href="/assets/js/16.e30cd155.js"><link rel="prefetch" href="/assets/js/17.3c9aa520.js"><link rel="prefetch" href="/assets/js/18.1d0bae0d.js"><link rel="prefetch" href="/assets/js/19.40396d12.js"><link rel="prefetch" href="/assets/js/2.d8f0ea9c.js"><link rel="prefetch" href="/assets/js/20.5255d394.js"><link rel="prefetch" href="/assets/js/21.28affb46.js"><link rel="prefetch" href="/assets/js/22.dba79a01.js"><link rel="prefetch" href="/assets/js/23.02383450.js"><link rel="prefetch" href="/assets/js/24.4367ae2b.js"><link rel="prefetch" href="/assets/js/25.2db7d111.js"><link rel="prefetch" href="/assets/js/26.66b39366.js"><link rel="prefetch" href="/assets/js/27.73333f76.js"><link rel="prefetch" href="/assets/js/28.f57d772c.js"><link rel="prefetch" href="/assets/js/29.75fe04f9.js"><link rel="prefetch" href="/assets/js/30.4fa924f3.js"><link rel="prefetch" href="/assets/js/31.3bc4b09a.js"><link rel="prefetch" href="/assets/js/32.e73a9df8.js"><link rel="prefetch" href="/assets/js/33.3c5c3e6d.js"><link rel="prefetch" href="/assets/js/34.26f37993.js"><link rel="prefetch" href="/assets/js/35.6fd0d388.js"><link rel="prefetch" href="/assets/js/36.d4a64a71.js"><link rel="prefetch" href="/assets/js/37.6a94a955.js"><link rel="prefetch" href="/assets/js/38.889dc17c.js"><link rel="prefetch" href="/assets/js/39.975067e9.js"><link rel="prefetch" href="/assets/js/4.e0f17090.js"><link rel="prefetch" href="/assets/js/40.4f36b71b.js"><link rel="prefetch" href="/assets/js/5.19ad076b.js"><link rel="prefetch" href="/assets/js/6.7cbf098b.js"><link rel="prefetch" href="/assets/js/7.b3f67ab4.js"><link rel="prefetch" href="/assets/js/8.39d73ebe.js"><link rel="prefetch" href="/assets/js/9.756a2b3d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.dd68a41e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Cold Elm Coders</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/articles/" class="nav-link">
  Articles
</a></div><div class="nav-item"><a href="/posts/" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="/Building-a-Database-Application-in-Blazor/" class="nav-link router-link-active">
  Database Application
</a></div><div class="nav-item"><a href="https://cec-blazor-examples.azurewebsites.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Demo Site
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/articles/" class="nav-link">
  Articles
</a></div><div class="nav-item"><a href="/posts/" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="/Building-a-Database-Application-in-Blazor/" class="nav-link router-link-active">
  Database Application
</a></div><div class="nav-item"><a href="https://cec-blazor-examples.azurewebsites.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Demo Site
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Blazor Database Application</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Building-a-Database-Application-in-Blazor/" aria-current="page" class="sidebar-link">Building a Database Application in Blazor</a></li><li><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-1.html" class="sidebar-link">Part 1 - Project Structure and Framework</a></li><li><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html" aria-current="page" class="active sidebar-link">Part 2 - Services - Building the CRUD Data Layers</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html#repository-and-database" class="sidebar-link">Repository and Database</a></li><li class="sidebar-sub-header"><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html#objective" class="sidebar-link">Objective</a></li><li class="sidebar-sub-header"><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html#services" class="sidebar-link">Services</a></li><li class="sidebar-sub-header"><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html#data-access" class="sidebar-link">Data Access</a></li><li class="sidebar-sub-header"><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html#data-classes" class="sidebar-link">Data Classes</a></li><li class="sidebar-sub-header"><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html#the-entity-framework-tier" class="sidebar-link">The Entity Framework Tier</a></li><li class="sidebar-sub-header"><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html#the-data-service-tier" class="sidebar-link">The Data Service Tier</a></li><li class="sidebar-sub-header"><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html#the-business-logic-controller-service-tier" class="sidebar-link">The Business Logic/Controller Service Tier</a></li><li class="sidebar-sub-header"><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html#wrap-up" class="sidebar-link">Wrap Up</a></li><li class="sidebar-sub-header"><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html#history" class="sidebar-link">History</a></li></ul></li><li><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-3.html" class="sidebar-link">Part 3 - View Components - CRUD Edit and View Operations in the UI</a></li><li><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-4.html" class="sidebar-link">Part 4 - UI Components</a></li><li><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-5.html" class="sidebar-link">Part 5 - View Components - CRUD List Operations in the UI</a></li><li><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-6.html" class="sidebar-link">Part 6 - Adding new Record Types and Their UI to the Weather Application</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="part-2-services-building-the-crud-data-layers"><a href="#part-2-services-building-the-crud-data-layers" class="header-anchor">#</a> Part 2 - Services - Building the CRUD Data Layers</h1> <p>This article is the second in a series on Building a Blazor Database Projects.  It describes techniques and methodologies for abstracting the data and business logic layers into boilerplate library code.  It is a total rewrite from earlier releases.</p> <ol><li>Project Structure and Framework.</li> <li>Services - Building the CRUD Data Layers.</li> <li>View Components - CRUD Edit and View Operations in the UI.</li> <li>UI Components - Building HTML/CSS Controls.</li> <li>View Components - CRUD List Operations in the UI.</li> <li>A walk through detailing how to add weather stations and weather station data to the application.</li></ol> <h2 id="repository-and-database"><a href="#repository-and-database" class="header-anchor">#</a> Repository and Database</h2> <p>The repository for the articles has moved to <a href="https://github.com/ShaunCurtis/CEC.Blazor.SPA" target="_blank" rel="noopener noreferrer">CEC.Blazor.SPA Repository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.  <a href="https://github.com/ShaunCurtis/CEC.Blazor" target="_blank" rel="noopener noreferrer">CEC.Blazor GitHub Repository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is obselete and will be removed.</p> <p>There's a SQL script in /SQL in the repository for building the database.</p> <p><a href="https://cec-blazor-server.azurewebsites.net/" target="_blank" rel="noopener noreferrer">You can see the Server and WASM versions of the project running here on the same site<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="objective"><a href="#objective" class="header-anchor">#</a> Objective</h2> <p>Before diving into specifics, our goal is a front end service that the UI uses that looks something like:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastControllerService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">FactoryControllerService<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">WeatherForecastControllerService</span><span class="token punctuation">(</span><span class="token class-name">IFactoryDataService</span> factoryDataService<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>factoryDataService<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>And a database inteface <code>DbContext</code> that looks like:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LocalWeatherDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">LocalWeatherDbContext</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptions<span class="token punctuation">&lt;</span>LocalWeatherDbContext<span class="token punctuation">&gt;</span></span> options<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
        <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// DbSet for the &lt;see cref=&quot;WeatherForecast&quot;/&gt; record</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> WeatherForecast <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre></div><p>And where all that is required to add a new record type is:</p> <ol><li>Add the necessary table to the database.</li> <li>Define a Dataclass.</li> <li>Define a <code>DbSet</code> in the <code>DbContext</code>.</li> <li>Define a  <code>public class nnnnnnControllerService : FactoryControllerService&lt;nnnnnn&gt;</code> Service and register it with the Services container.</li></ol> <h2 id="services"><a href="#services" class="header-anchor">#</a> Services</h2> <p>Blazor is built on DI [Dependency Injection] and IOC [Inversion of Control] principles.  If you're unfamiliar with these concepts, do a little <a href="https://www.codeproject.com/Articles/5274732/Dependency-Injection-and-IoC-Containers-in-Csharp" target="_blank" rel="noopener noreferrer">backgound reading<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> before diving into Blazor.  You'll save yourself a lot of time in the long run!</p> <p>Blazor Singleton and Transient services are relatively straight forward.  You can read more about them in the <a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/fundamentals/dependency-injection" target="_blank" rel="noopener noreferrer">Microsoft Documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.  Scoped are a little more complicated.</p> <ol><li>A scoped service object exists for the lifetime of a client application session - note client and not server.  Any application resets, such as F5 or navigation away from the application, resets all scoped services.  A duplicated tab in a browser creates a new application, and a new set of scoped services.</li> <li>A scoped service can be scoped to an object in code.  This is most common in a UI conponent.  The <code>OwningComponentBase</code> component class has functionality to restrict the life of a scoped service to the lifetime of the component. This is covered in more detail in another article.</li></ol> <p><code>Services</code> is the Blazor IOC [Inversion of Control] container.</p> <p>In Blazor Server services are configured in <code>startup.cs</code>:</p> <p>Note we're using a Service Colection extension <code>AddApplicationServices</code> to execute all the application specific services.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// CEC.Blazor.Server/startup.cs</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddRazorPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddServerSideBlazor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// the Services for the CEC.Blazor .</span>
    services<span class="token punctuation">.</span><span class="token function">AddCECBlazorSPA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// the local application Services defined in ServiceCollectionExtensions.cs</span>
    services<span class="token punctuation">.</span><span class="token function">AddApplicationServices</span><span class="token punctuation">(</span>Configurtion<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>AddApplicationServices</code> is shown below.  It's declared within a static class as a static extension.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token operator">/</span>Extensions<span class="token operator">/</span>ServiceCollectionExtensions<span class="token punctuation">.</span>cs
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">AddApplicationServices</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    <span class="token comment">// Local DB Setup</span>
    <span class="token comment">//var dbContext = configuration.GetValue&lt;string&gt;(&quot;Configuration:DBContext&quot;);</span>
    <span class="token comment">//services.AddDbContextFactory&lt;LocalWeatherDbContext&gt;(options =&gt; options.UseSqlServer(dbContext), ServiceLifetime.Singleton);</span>
    <span class="token comment">//services.AddSingleton&lt;IFactoryDataService, LocalDatabaseDataService&gt;();</span>

    <span class="token comment">// In Memory DB Setup</span>
    <span class="token class-name"><span class="token keyword">var</span></span> memdbContext <span class="token operator">=</span> <span class="token string">&quot;Data Source=:memory:&quot;</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContextFactory</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>InMemoryWeatherDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span> options<span class="token punctuation">.</span><span class="token function">UseSqlite</span><span class="token punctuation">(</span>memdbContext<span class="token punctuation">)</span><span class="token punctuation">,</span> ServiceLifetime<span class="token punctuation">.</span>Singleton<span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFactoryDataService<span class="token punctuation">,</span> TestDatabaseDataService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecastControllerService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> services<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>and <code>program.cs</code> in WASM mode:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// program.cs</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token range operator">..</span><span class="token range operator">..</span><span class="token punctuation">.</span>
    <span class="token comment">// Added here as we don't have access to builder in AddApplicationServices</span>
    builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddScoped</span><span class="token punctuation">(</span>sp <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpClient</span> <span class="token punctuation">{</span> BaseAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>HostEnvironment<span class="token punctuation">.</span>BaseAddress<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// the Services for the Application</span>
    builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddApplicationServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token range operator">..</span><span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// ServiceCollectionExtensions.cs</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">AddApplicationServices</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFactoryDataService<span class="token punctuation">,</span> FactoryWASMDataService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherForecastControllerService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> services<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Points:</p> <ol><li>There's an <code>IServiceCollection</code> extension method for each project/library to encapsulate the specific services needed for the project.</li> <li>Only the data layer service is different.  The Server version, used by both the Blazor Server and the WASM API Server, interfaces with the database and Entitiy Framework.  It's scoped as a Singleton.  We running async, so we use the DbContextFactory and create and close DbContexts per query.  The Client version uses <code>HttpClient</code> (which is a scoped service) to make calls to the API and is therefore itself scoped.  There's also a &quot;dummy&quot; data service that uses the SQLite in-memory database.</li> <li><code>FactoryDataService</code> implementing <code>IFactoryDataService</code> is used to process all the data requests through generics, <code>TRecord</code> defining which dataset is retrieved and returned.   These services, along with a set of <code>DbContext</code> extensions, boilerplate all the core data service code into library classes.</li></ol> <h3 id="generics"><a href="#generics" class="header-anchor">#</a> Generics</h3> <p>The boilerplate library code relies heavily on Generics.  The two generic entities used are:</p> <ol><li><code>TRecord</code> - this represents a model record class.  It must implement <code>IDbRecord</code>, a vanilla <code>new()</code> and be a class.  <code>TRecord</code> is defined on a Method by Method basis, not at the class level.</li> <li><code>TDbContext</code> - this is the database context and must inherit from the <code>DbContext</code> class.</li></ol> <p>Class declarations look like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token operator">/</span>Services<span class="token operator">/</span>FactoryDataService<span class="token punctuation">.</span>cs
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">FactoryDataService<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IFactoryDataService<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span></span>
    <span class="token keyword">where</span> <span class="token class-name">TContext</span> <span class="token punctuation">:</span> DbContext
<span class="token range operator">..</span><span class="token range operator">..</span><span class="token range operator">..</span>
    <span class="token comment">// example method template  </span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="data-access"><a href="#data-access" class="header-anchor">#</a> Data Access</h2> <p>Before we dive into the detail, let's look at the main CRUDL methods we need to implement:</p> <ol><li><em>GetRecordList</em> - get a List of all the records in the dataset.</li> <li><em>GetRecord</em> - get a single record by ID or GUID</li> <li><em>CreateRecord</em> - Create a new record</li> <li><em>UpdateRecord</em> - Update the record based on ID</li> <li><em>DeleteRecord</em> - Delete the record based on ID</li></ol> <p>Keep these in mind as we work through the data layers.</p> <h4 id="dbtaskresult"><a href="#dbtaskresult" class="header-anchor">#</a> DbTaskResult</h4> <p>Data layer CUD operations return a <code>DbTaskResult</code> object.  Most of the properties are self-evident.  The UI can use the information returned to display messages based on the result.  <code>NewID</code> returns the new ID from a Create operation.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DbTaskResult</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Message <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">&quot;New Object Message&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">MessageType</span> Type <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> MessageType<span class="token punctuation">.</span>None<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsOK <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> NewID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="data-classes"><a href="#data-classes" class="header-anchor">#</a> Data Classes</h2> <p>Data classes implement <code>IDbRecord</code>.</p> <ol><li><code>ID</code> is the standard database Identity field</li> <li><code>GUID</code> is a unique identifier for this copy of the record</li> <li><code>DisplayName</code> provides a generic name for the record</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDbRecord<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> 
        <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> GUID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> DisplayName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="weatherforecast"><a href="#weatherforecast" class="header-anchor">#</a> WeatherForecast</h3> <p>Points:</p> <ol><li>Use of Attributes for Entity Framework.</li> <li>Implementation of <code>IDbRecord</code>.</li> <li>Implementation of <code>IValidation</code> for Validation we saw in one of the previous articles.</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecast</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IValidation</span><span class="token punctuation">,</span> <span class="token class-name">IDbRecord<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Key</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> Date <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> TemperatureC <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NotMapped</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> TemperatureF <span class="token operator">=&gt;</span> <span class="token number">32</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>TemperatureC <span class="token operator">/</span> <span class="token number">0.5556</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Summary <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NotMapped</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> GUID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> init<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NotMapped</span></span><span class="token punctuation">]</span> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> DisplayName <span class="token operator">=&gt;</span> <span class="token interpolation-string"><span class="token string">$&quot;Weather Forecast for </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token keyword">this</span><span class="token punctuation">.</span>Date<span class="token punctuation">.</span><span class="token function">ToShortDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string"> &quot;</span></span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">Validate</span><span class="token punctuation">(</span><span class="token class-name">ValidationMessageStore</span> validationMessageStore<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> fieldname<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> model <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            model <span class="token operator">=</span> model <span class="token operator">??</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">bool</span></span> trip <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>Summary<span class="token punctuation">.</span><span class="token function">Validation</span><span class="token punctuation">(</span><span class="token string">&quot;Summary&quot;</span><span class="token punctuation">,</span> model<span class="token punctuation">,</span> validationMessageStore<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">LongerThan</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;Your description needs to be a little longer! 3 letters minimum&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> trip<span class="token punctuation">,</span> fieldname<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>Date<span class="token punctuation">.</span><span class="token function">Validation</span><span class="token punctuation">(</span><span class="token string">&quot;Date&quot;</span><span class="token punctuation">,</span> model<span class="token punctuation">,</span> validationMessageStore<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">NotDefault</span><span class="token punctuation">(</span><span class="token string">&quot;You must select a date&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">LessThan</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddMonths</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;Date can only be up to 1 month ahead&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> trip<span class="token punctuation">,</span> fieldname<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>TemperatureC<span class="token punctuation">.</span><span class="token function">Validation</span><span class="token punctuation">(</span><span class="token string">&quot;TemperatureC&quot;</span><span class="token punctuation">,</span> model<span class="token punctuation">,</span> validationMessageStore<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">LessThan</span><span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token string">&quot;The temperature must be less than 70C&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">GreaterThan</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token string">&quot;The temperature must be greater than -60C&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> trip<span class="token punctuation">,</span> fieldname<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token operator">!</span>trip<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><h2 id="the-entity-framework-tier"><a href="#the-entity-framework-tier" class="header-anchor">#</a> The Entity Framework Tier</h2> <p>In the application we implement two Entity Framework DBContexts.</p> <h4 id="weatherforecastdbcontext"><a href="#weatherforecastdbcontext" class="header-anchor">#</a> WeatherForecastDBContext</h4> <p>The <code>DbContext</code> has a <code>DbSet</code> per record type.  Each <code>DbSet</code> is linked to a view in <code>OnModelCreating()</code>.  The WeatherForecast application has one record type.</p> <h4 id="localweatherdbcontext"><a href="#localweatherdbcontext" class="header-anchor">#</a> LocalWeatherDbContext</h4> <p>The class looks like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LocalWeatherDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Guid</span> _id<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">LocalWeatherDbContext</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptions<span class="token punctuation">&lt;</span>LocalWeatherDbContext<span class="token punctuation">&gt;</span></span> options<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> _id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> WeatherForecast <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id=""><a href="#" class="header-anchor">#</a></h4> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InMemoryWeatherDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Guid</span> _id<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">InMemoryWeatherDbContext</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptions<span class="token punctuation">&lt;</span>InMemoryWeatherDbContext<span class="token punctuation">&gt;</span></span> options<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">BuildInMemoryDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> WeatherForecast <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BuildInMemoryDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> conn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">GetDbConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            conn<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> cmd <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">CreateCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cmd<span class="token punctuation">.</span>CommandText <span class="token operator">=</span> <span class="token string">&quot;CREATE TABLE [WeatherForecast]([ID] INTEGER PRIMARY KEY AUTOINCREMENT, [Date] [smalldatetime] NOT NULL, [TemperatureC] [int] NOT NULL, [Summary] [varchar](255) NULL)&quot;</span><span class="token punctuation">;</span>
            cmd<span class="token punctuation">.</span><span class="token function">ExecuteNonQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> forecast <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>NewForecasts<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                cmd<span class="token punctuation">.</span>CommandText <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;INSERT INTO WeatherForecast([Date], [TemperatureC], [Summary]) VALUES('</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">forecast<span class="token punctuation">.</span>Date<span class="token punctuation">.</span><span class="token function">ToLongDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">', </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">forecast<span class="token punctuation">.</span>TemperatureC</span><span class="token punctuation">}</span></span><span class="token string">, '</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">forecast<span class="token punctuation">.</span>Summary</span><span class="token punctuation">}</span></span><span class="token string">')&quot;</span></span><span class="token punctuation">;</span>
                cmd<span class="token punctuation">.</span><span class="token function">ExecuteNonQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> Summaries <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;Freezing&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bracing&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Chilly&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Cool&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mild&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Warm&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Balmy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Hot&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Sweltering&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Scorching&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> NewForecasts
        <span class="token punctuation">{</span>
            <span class="token keyword">get</span>
            <span class="token punctuation">{</span>
                <span class="token punctuation">{</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">return</span> Enumerable<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>index <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WeatherForecast</span>
                    <span class="token punctuation">{</span>
                        <span class="token comment">//ID = index,</span>
                        Date <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        TemperatureC <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        Summary <span class="token operator">=</span> Summaries<span class="token punctuation">[</span>rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>Summaries<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">]</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

</code></pre></div><p>It looks pretty bare because most of the real database activity takes place in a set of extensions.  Out-of-the-box <code>DbContext</code> doesn't provide the Stored Procedure and generics support we require, so we add that functionality through a set of extensions on <code>DbContext</code>.  These are defined in the static class <code>DbContextExtensions</code>.  We'll look at the methods individually.</p> <p><code>GetDbSet</code> is a utility function to get the correct <code>DbSet</code> for the record type defined in <code>TRecord</code>.  <code>TRecord</code> must implement <code>IDbRecord</code> (we'll look at it shortly).  <code>IDbRecord</code> has a <code>DbRecordInfo</code> property <code>RecordInfo</code> which contains the information we need to get the correct <code>DbSet</code>.  The <code>DbSet</code> name can be provided directly provided as <code>dbSetName</code> when we call the method, or (normally the case), the method creates an instance of <code>TRecord</code> and gets <code>RecordInfo</code> to get the <code>DbSet</code> name.  The method uses reflection to get the correct reference to the <code>DbSet</code>, casts it and returns the casted reference.  To be clear, we return a reference to the correct <code>DbSet</code> in <code>WeatherForecastDbContext</code>.  If <code>TRecord</code> is <code>DbWeatherForecast</code>, the <code>RecordName</code> defined in <code>RecordInfo</code> is <em>WeatherForecast</em>, <code>GetDbSet</code> returns a reference to <code>DbWeatherForecast.WeatherForecast</code>.  With the correct <code>DbSet</code> we can run Linq queries against that <code>DbSet</code>.  <code>DbContext</code> will translate those Linq queries into SQL queries against the database View.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">DbContext</span> context<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> dbSetName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Get the property info object for the DbSet </span>
    <span class="token class-name"><span class="token keyword">var</span></span> rec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> pinfo <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span>dbSetName <span class="token operator">??</span> rec<span class="token punctuation">.</span>RecordInfo<span class="token punctuation">.</span>RecordName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Get the property DbSet</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>DbSet<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">)</span>pinfo<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>GetRecordAsync</code> uses <code>GetDbSet</code> to get the <code>DbSet</code>, queries the <code>DbSet</code> for the specific record and returns it.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">DbContext</span> context<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> dbSetName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> <span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dbSetName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> dbset<span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">)</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span>ID <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>GetRecordListAsync</code> gets a <code>&lt;List&lt;TRecord&gt;&gt;</code> from the <code>DbSet</code> for <code>TRecord</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">DbContext</span> context<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> dbSetName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> <span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dbSetName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> dbset<span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>GetRecordFilteredListAsync</code> gets a <code>&lt;List&lt;TRecord&gt;&gt;</code> based on the filters set in <code>filterList</code>.  It cycles through the filters applying them sequentially.  The method runs the filter against the <code>DbSet</code> until it gets a result, then runs the rest of the filters against <code>list</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordFilteredListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">DbContext</span> context<span class="token punctuation">,</span> <span class="token class-name">FilterListCollection</span> filterList<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> dbSetName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Get the DbSet</span>
    <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> <span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Get a empty list</span>
    <span class="token class-name"><span class="token keyword">var</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// if we have a filter go through each filter</span>
    <span class="token comment">// note that only the first filter runs a SQL query against the database</span>
    <span class="token comment">// the rest are run against the dataset.  So do the biggest slice with the first filter for maximum efficiency.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filterList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> filterList<span class="token punctuation">.</span>Filters<span class="token punctuation">.</span>Count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token keyword">in</span> filterList<span class="token punctuation">.</span>Filters<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Get the filter propertyinfo object</span>
            <span class="token class-name"><span class="token keyword">var</span></span> x <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TRecord</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// We have records so need to filter on the list</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span>Count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                list <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// We don't have any records so can query the DbSet directly</span>
            <span class="token keyword">else</span>
                list <span class="token operator">=</span> <span class="token keyword">await</span> dbset<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//  No list, just get the full recordset if allowed by filterlist</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filterList<span class="token punctuation">.</span>OnlyLoadIfFilters<span class="token punctuation">)</span>
        list <span class="token operator">=</span> <span class="token keyword">await</span> dbset<span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// otherwise return an empty list</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>GetLookupListAsync</code> gets a <code>SortedDictionary</code> for the UI to use in Selects.  It gets the <code>DbSet</code> for <code>TRecord</code> and builds a <code>SortedDictionary</code> from the <code>ID</code> and <code>DisplayName</code> fields.  <code>ID</code> and <code>DisplayName</code> are defined in the <code>IDbRecord</code> interface.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetLookupListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">DbContext</span> context<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> <span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dbset <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">await</span> dbset<span class="token punctuation">.</span><span class="token function">ForEachAsync</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> list<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> item<span class="token punctuation">.</span>DisplayName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>GetDistinctListAsync</code> gets a <code>List&lt;string&gt;</code> of <code>fieldName</code> from the <code>DbSet</code> for <code>TRecord</code>.  It uses reflection to the the <code>PropertyInfo</code> for <code>fieldName</code> and then runs a <code>Select</code> on <code>DbSet</code> to get the values, converting them to a string in the process.  It finally runs a <code>Distinct</code> operation on the list.  It's done this way as running <code>Distinct</code> on the <code>DbSet</code> doesn't work.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetDistinctListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">DbContext</span> context<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> fieldName<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> dbset <span class="token operator">=</span> <span class="token generic-method"><span class="token function">GetDbSet</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> x <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TRecord</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dbset <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> x <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// we get the full list and then run a distinct because we can't run a distinct directly on the dbSet</span>
        <span class="token class-name"><span class="token keyword">var</span></span> fulllist <span class="token operator">=</span> <span class="token keyword">await</span> dbset<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list <span class="token operator">=</span> fulllist<span class="token punctuation">.</span><span class="token function">Distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> list <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>ExecStoredProcAsync</code> is a classic Stored Procedure implementation run through a <code>DbCommand</code> obtained from  Entity Framework's underlying database connection.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">ExecStoredProcAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">DbContext</span> context<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> storedProcName<span class="token punctuation">,</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>SqlParameter<span class="token punctuation">&gt;</span></span> parameters<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> cmd <span class="token operator">=</span> context<span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">GetDbConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cmd<span class="token punctuation">.</span>CommandText <span class="token operator">=</span> storedProcName<span class="token punctuation">;</span>
    cmd<span class="token punctuation">.</span>CommandType <span class="token operator">=</span> CommandType<span class="token punctuation">.</span>StoredProcedure<span class="token punctuation">;</span>
    parameters<span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> cmd<span class="token punctuation">.</span>Parameters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>Connection<span class="token punctuation">.</span>State <span class="token operator">==</span> ConnectionState<span class="token punctuation">.</span>Closed<span class="token punctuation">)</span> cmd<span class="token punctuation">.</span>Connection<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> cmd<span class="token punctuation">.</span><span class="token function">ExecuteNonQueryAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Debug<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">finally</span>
        <span class="token punctuation">{</span>
            cmd<span class="token punctuation">.</span>Connection<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="the-data-service-tier"><a href="#the-data-service-tier" class="header-anchor">#</a> The Data Service Tier</h2> <h4 id="ifactorydataservice"><a href="#ifactorydataservice" class="header-anchor">#</a> IFactoryDataService</h4> <p>Core Data Service functionality is defined in the <code>IFactoryDataService</code> interface.
Important points to understand at this point are:</p> <ol><li>All methods are <code>async</code>, returning <code>Tasks</code>.</li> <li>All methods use generics. <code>TRecord</code> defines the record type.</li> <li>CUD operations return a <code>DbTaskResult</code> object that contains detail about the result.</li> <li>There's a filtered version of get list using a <code>IFilterList</code> object defining the filters to apply to the returned dataset.</li> <li><code>GetLookupListAsync</code> provides a Id/Value <code>SortedDictionary</code> to use in <em>Select</em> controls in the UI.</li> <li><code>GetDistinctListAsync</code> builds a unique list of the field defined in <code>DbDinstinctRequest</code>.  These are used in filter list controls in the UI.</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// CEC.Blazor.SPA/Services/Interfaces</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFactoryDataService<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span> 
    <span class="token keyword">where</span> <span class="token class-name">TContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">HttpClient</span> HttpClient <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">IDbContextFactory<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span> DBContext <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">IConfiguration</span> AppConfiguration <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetFilteredRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">IFilterList</span> filterList<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Guid</span> guid<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CreateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetLookupListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TLookup<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TLookup</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TLookup<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetDistinctListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> fieldName<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        
    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>DbBaseRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetBaseRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TLookup<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TLookup</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TLookup<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>SqlParameter<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetSQLParameters</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> item<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">bool</span></span> withid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="factorydataservice"><a href="#factorydataservice" class="header-anchor">#</a> FactoryDataService</h4> <p><code>FactoryDataService</code> is a base abstract implementation of the Interface</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// CEC.Blazor.SPA/Services/Base</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">FactoryDataService<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IFactoryDataService<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span></span>
        <span class="token keyword">where</span> <span class="token class-name">TContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> ServiceID <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">HttpClient</span> HttpClient <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IDbContextFactory<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span> DBContext <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">IConfiguration</span> AppConfiguration <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token function">FactoryDataService</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>AppConfiguration <span class="token operator">=</span> configuration<span class="token punctuation">;</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// Gets the Record Name from TRecord</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;typeparam name=&quot;TRecord&quot;&gt;&lt;/typeparam&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">protected</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">GetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> rec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> rec<span class="token punctuation">.</span>RecordInfo<span class="token punctuation">.</span>RecordName <span class="token operator">??</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">protected</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token generic-method"><span class="token function">TryGetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> rec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            name <span class="token operator">=</span> rec<span class="token punctuation">.</span>RecordInfo<span class="token punctuation">.</span>RecordName <span class="token operator">??</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetFilteredRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">FilterListCollection</span> filterList<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Guid</span> guid<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> IsOK <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> Type <span class="token operator">=</span> MessageType<span class="token punctuation">.</span>NotImplemented<span class="token punctuation">,</span> Message <span class="token operator">=</span> <span class="token string">&quot;Method not implemented&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CreateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> IsOK <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> Type <span class="token operator">=</span> MessageType<span class="token punctuation">.</span>NotImplemented<span class="token punctuation">,</span> Message <span class="token operator">=</span> <span class="token string">&quot;Method not implemented&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> IsOK <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> Type <span class="token operator">=</span> MessageType<span class="token punctuation">.</span>NotImplemented<span class="token punctuation">,</span> Message <span class="token operator">=</span> <span class="token string">&quot;Method not implemented&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetLookupListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TLookup<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TLookup</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TLookup<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetLookupListAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> recordName<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetDistinctListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> fieldName<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>SqlParameter<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetSQLParameters</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> item<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">bool</span></span> withid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>SqlParameter<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="factoryserverdataservice"><a href="#factoryserverdataservice" class="header-anchor">#</a> FactoryServerDataService</h4> <p><code>FactoryServerDataService</code> is a concrete implementation of <code>IFactoryDataService</code>.  Methods call back into the <code>DBContext</code> extension methods.</p> <p><code>RunStoredProcedure</code>:</p> <ol><li>Uses the <code>RecordInfo</code> property of an instance of <code>TRecord</code> to get the correct stored procedure</li> <li>Builds the SQLParameters through <code>GetSQLParameters</code> which reads the <code>SPParameters</code> attribute labelled properties of <code>TRecord</code>.</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// CEC.Blazor.SPA/Services/Base</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FactoryServerDataService<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span>
        <span class="token type-list"><span class="token class-name">FactoryDataService<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
        <span class="token class-name">IFactoryDataService<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span></span>
        <span class="token keyword">where</span> <span class="token class-name">TContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
    <span class="token punctuation">{</span>

        <span class="token keyword">public</span> <span class="token function">FactoryServerDataService</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">IDbContextFactory<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span> dbContext<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext <span class="token operator">=</span> dbContext<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetFilteredRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">FilterListCollection</span> filterList<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordFilteredListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>filterList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Guid</span> guid<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>guid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RunStoredProcedure</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> SPType<span class="token punctuation">.</span>Update<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CreateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RunStoredProcedure</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> SPType<span class="token punctuation">.</span>Create<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RunStoredProcedure</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> SPType<span class="token punctuation">.</span>Delete<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetDistinctListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> fieldName<span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDistinctListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetLookupListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TLookup<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">=&gt;</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetLookupListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TLookup<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">RunStoredProcedure</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">,</span> <span class="token class-name">SPType</span> spType<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> recordInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>RecordInfo<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                Message <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;Error saving </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">recordInfo<span class="token punctuation">.</span>RecordDescription</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
                IsOK <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                Type <span class="token operator">=</span> MessageType<span class="token punctuation">.</span>Danger
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> spname <span class="token operator">=</span> spType <span class="token keyword">switch</span>
            <span class="token punctuation">{</span>
                SPType<span class="token punctuation">.</span>Create <span class="token operator">=&gt;</span> recordInfo<span class="token punctuation">.</span>CreateSP<span class="token punctuation">,</span>
                SPType<span class="token punctuation">.</span>Update <span class="token operator">=&gt;</span> recordInfo<span class="token punctuation">.</span>UpdateSP<span class="token punctuation">,</span>
                SPType<span class="token punctuation">.</span>Delete <span class="token operator">=&gt;</span> recordInfo<span class="token punctuation">.</span>DeleteSP<span class="token punctuation">,</span>
                _ <span class="token operator">=&gt;</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> parms <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetSQLParameters</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> spType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>DBContext<span class="token punctuation">.</span><span class="token function">CreateDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ExecStoredProcAsync</span><span class="token punctuation">(</span>spname<span class="token punctuation">,</span> parms<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> idparam <span class="token operator">=</span> parms<span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>Direction <span class="token operator">==</span> ParameterDirection<span class="token punctuation">.</span>Output <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>SqlDbType <span class="token operator">==</span> SqlDbType<span class="token punctuation">.</span>Int <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>ParameterName<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">&quot;ID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    Message <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">recordInfo<span class="token punctuation">.</span>RecordDescription</span><span class="token punctuation">}</span></span><span class="token string"> saved&quot;</span></span><span class="token punctuation">,</span>
                    IsOK <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    Type <span class="token operator">=</span> MessageType<span class="token punctuation">.</span>Success
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>idparam <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> ret<span class="token punctuation">.</span>NewID <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>idparam<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>SqlParameter<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetSQLParameters</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">,</span> <span class="token class-name">SPType</span> spType<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRecord</span> <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> IDbRecord<span class="token operator">&lt;</span>TRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>SqlParameter<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> prop <span class="token keyword">in</span> <span class="token punctuation">(</span>record <span class="token keyword">as</span> <span class="token class-name">IDbRecord<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetSPParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> attr <span class="token operator">=</span> prop<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetCustomAttribute</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SPParameterAttribute<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                attr<span class="token punctuation">.</span><span class="token function">CheckName</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// If its a delete we only need the ID and then break out of the for</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>attr<span class="token punctuation">.</span>IsID <span class="token operator">&amp;&amp;</span> spType <span class="token operator">==</span> SPType<span class="token punctuation">.</span>Delete<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    parameters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlParameter</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span>ParameterName<span class="token punctuation">,</span> attr<span class="token punctuation">.</span>DataType<span class="token punctuation">)</span> <span class="token punctuation">{</span> Direction <span class="token operator">=</span> ParameterDirection<span class="token punctuation">.</span>Input<span class="token punctuation">,</span> Value <span class="token operator">=</span> prop<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// skip if its a delete</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>spType <span class="token operator">!=</span> SPType<span class="token punctuation">.</span>Delete<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">// if its a create add the ID as an output foe capturing the new ID</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>attr<span class="token punctuation">.</span>IsID <span class="token operator">&amp;&amp;</span> spType <span class="token operator">==</span> SPType<span class="token punctuation">.</span>Create<span class="token punctuation">)</span> parameters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlParameter</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span>ParameterName<span class="token punctuation">,</span> attr<span class="token punctuation">.</span>DataType<span class="token punctuation">)</span> <span class="token punctuation">{</span> Direction <span class="token operator">=</span> ParameterDirection<span class="token punctuation">.</span>Output <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// Deal with dates</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>attr<span class="token punctuation">.</span>DataType <span class="token operator">==</span> SqlDbType<span class="token punctuation">.</span>SmallDateTime<span class="token punctuation">)</span> parameters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlParameter</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span>ParameterName<span class="token punctuation">,</span> attr<span class="token punctuation">.</span>DataType<span class="token punctuation">)</span> <span class="token punctuation">{</span> Direction <span class="token operator">=</span> ParameterDirection<span class="token punctuation">.</span>Input<span class="token punctuation">,</span> Value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">)</span>prop<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;dd-MMM-yyyy&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// Deal with Strings in default or null</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>attr<span class="token punctuation">.</span>DataType <span class="token operator">==</span> SqlDbType<span class="token punctuation">.</span>NVarChar <span class="token operator">||</span> attr<span class="token punctuation">.</span>DataType <span class="token operator">==</span> SqlDbType<span class="token punctuation">.</span>VarChar<span class="token punctuation">)</span> parameters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlParameter</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span>ParameterName<span class="token punctuation">,</span> attr<span class="token punctuation">.</span>DataType<span class="token punctuation">)</span> <span class="token punctuation">{</span> Direction <span class="token operator">=</span> ParameterDirection<span class="token punctuation">.</span>Input<span class="token punctuation">,</span> Value <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>prop<span class="token punctuation">.</span><span class="token function">GetValueAsString</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">:</span> prop<span class="token punctuation">.</span><span class="token function">GetValueAsString</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> parameters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlParameter</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span>ParameterName<span class="token punctuation">,</span> attr<span class="token punctuation">.</span>DataType<span class="token punctuation">)</span> <span class="token punctuation">{</span> Direction <span class="token operator">=</span> ParameterDirection<span class="token punctuation">.</span>Input<span class="token punctuation">,</span> Value <span class="token operator">=</span> prop<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> parameters<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="factorywasmdataservice"><a href="#factorywasmdataservice" class="header-anchor">#</a> FactoryWASMDataService</h4> <p><code>FactoryWASMDataService</code> is the WASM client implementation of <code>IFactoryDataService</code>.  It makes API calls into the server controller services.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// CEC.Blazor/Services/Base</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FactoryWASMDataService<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span>
        <span class="token type-list"><span class="token class-name">FactoryDataService<span class="token punctuation">&lt;</span>TContext<span class="token punctuation">&gt;</span></span></span>
        <span class="token keyword">where</span> <span class="token class-name">TContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
    <span class="token punctuation">{</span>

        <span class="token keyword">public</span> <span class="token function">FactoryWASMDataService</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">HttpClient</span> httpClient<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span> 
            <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient <span class="token operator">=</span> httpClient<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-method"><span class="token function">TryGetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> recName<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token function">PostAsJsonAsync</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">recName</span><span class="token punctuation">}</span></span><span class="token string">/read?gid=</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                result <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result <span class="token operator">??</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetLookupListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-method"><span class="token function">TryGetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> recName<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">recName</span><span class="token punctuation">}</span></span><span class="token string">/lookuplist?gid=</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result <span class="token operator">??</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetDistinctListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> fieldName<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-method"><span class="token function">TryGetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> recName<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token function">PostAsJsonAsync</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">recName</span><span class="token punctuation">}</span></span><span class="token string">/distinctlist?gid=</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                result <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result <span class="token operator">??</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetFilteredRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">FilterListCollection</span> filterList<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-method"><span class="token function">TryGetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> recName<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">PostAsJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>FilterListCollection<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">recName</span><span class="token punctuation">}</span></span><span class="token string">/filteredlist?gid=</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> filterList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                result <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result <span class="token operator">??</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-method"><span class="token function">TryGetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> recName<span class="token punctuation">)</span><span class="token punctuation">)</span>
                result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">recName</span><span class="token punctuation">}</span></span><span class="token string">/list?gid=</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">GetRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-method"><span class="token function">TryGetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> recName<span class="token punctuation">)</span><span class="token punctuation">)</span>
                result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">recName</span><span class="token punctuation">}</span></span><span class="token string">/count?gid=</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-method"><span class="token function">TryGetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> recName<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">PostAsJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">recName</span><span class="token punctuation">}</span></span><span class="token string">/update?gid=</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span>
                result <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result <span class="token operator">??</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CreateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-method"><span class="token function">TryGetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> recName<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">PostAsJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">recName</span><span class="token punctuation">}</span></span><span class="token string">/create?gid=</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span>
                result <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result <span class="token operator">??</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TRecord</span> record<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DbTaskResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-method"><span class="token function">TryGetRecordName</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> recName<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">PostAsJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">recName</span><span class="token punctuation">}</span></span><span class="token string">/delete?gid=</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span>
                result <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result <span class="token operator">??</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>We'll look at the Server Side Controller shortly.</p> <h2 id="the-business-logic-controller-service-tier"><a href="#the-business-logic-controller-service-tier" class="header-anchor">#</a> The Business Logic/Controller Service Tier</h2> <p>Controllers are normally configured as Scoped Services.</p> <p>The controller tier interface and base class are generic and reside in the CEC.Blazor.SPA library.  Two interfaces <code>IFactoryControllerService</code> and <code>IControllerPagingService</code> define the required functionality.  Both are implemented in the <code>FactoryControllerService</code> class.</p> <p>The code for these services is far too long to reproduce here.  <code>FactoryControllerService</code> is split into three partial classes.  We'll cover most of the functionality when we look at how the UI layer interfaces with the controller layer.</p> <p>The main functionality implemented is:</p> <ol><li>Properties to hold the current record and recordset and their status.</li> <li>Properties and methods - defined in <code>IControllerPagingService</code> - for UI paging operations on large datasets.</li> <li>Properties and methods to sort the the dataset.</li> <li>Properties and methods to track the edit status of the record (Dirty/Clean).</li> <li>Methods to implement CRUD operations through the IDataService Interface.</li> <li>Events triggered on record and record set changes.  Used by the UI to control page refreshes.</li> <li>Methods to reset the Controller to a vanilla state.</li></ol> <p>All code needed to provide the above functionality is boilerplated in the base class.  Implementing specific record based controllers is a simple task with minimal coding.</p> <h4 id="weatherforecastcontrollerservice"><a href="#weatherforecastcontrollerservice" class="header-anchor">#</a> WeatherForecastControllerService</h4> <p>Let's look at the <code>WeatherForecastControllerService</code> as an example.</p> <p>The class:</p> <ol><li>Inherits from <code>FactoryControllerService</code> and sets the generic <code>TDbContext</code> and <code>TRecord</code> to specific classes.</li> <li>Implements the class constructor that gets the required DI services and sets up the base class.</li> <li>Gets the Dictionary object for the Outlook Enum Select box in the UI.</li></ol> <p>Note that the data service used is the <code>IFactoryDataService</code> configured in Services.  For WASM this is <code>FasctoryWASMDataService</code> and for Server or the API EASM Server this is <code>FactoryServerDataService</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// CEC.Weather/Controllers/ControllerServices/WeatherForecastControllerService.cs</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastControllerService</span> <span class="token punctuation">:</span> 
    <span class="token type-list"><span class="token class-name">FactoryControllerService<span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">,</span> WeatherForecastDbContext<span class="token punctuation">&gt;</span></span></span> 
<span class="token punctuation">{</span>
    <span class="token comment">/// List of Outlooks for Select Controls</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> OutlookOptionList <span class="token operator">=&gt;</span> Utils<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetEnumList</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WeatherOutlook<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">WeatherForecastControllerService</span><span class="token punctuation">(</span><span class="token class-name">NavigationManager</span> navmanager<span class="token punctuation">,</span> <span class="token class-name">IConfiguration</span> appconfiguration<span class="token punctuation">,</span> <span class="token class-name">IFactoryDataService<span class="token punctuation">&lt;</span>WeatherForecastDbContext<span class="token punctuation">&gt;</span></span> dataService<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>appconfiguration<span class="token punctuation">,</span> navmanager<span class="token punctuation">,</span>dataService<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="api-controllers"><a href="#api-controllers" class="header-anchor">#</a> API Controllers</h4> <p>While they are not a service they are the final bit of the data layers to cover.  All the controllers use  the <code>IFactoryDataService</code> service to access the <code>FactoryServerDataService</code> data layer.  There's a controller per record.  We'll look at <code>WeatherForecastController</code> to review the code.</p> <p>Note:</p> <ol><li>It gets the <code>IFactoryDataService</code> when the controller is initialized.</li> <li>It maps the API calls directly into the <code>IFactoryDataService</code> methods.</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// CEC.Blazor.WASM.Server/Controllers/WeatherForecastController.cs</span>
<span class="token punctuation">[</span>ApiController<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token return-type class-name">IFactoryDataService<span class="token punctuation">&lt;</span>WeatherForecastDbContext<span class="token punctuation">&gt;</span></span> DataService <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>WeatherForecastController<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">WeatherForecastController</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>WeatherForecastController<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">,</span> <span class="token class-name">IFactoryDataService<span class="token punctuation">&lt;</span>WeatherForecastDbContext<span class="token punctuation">&gt;</span></span> dataService<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>DataService <span class="token operator">=</span> dataService<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/list&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/filteredlist&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetFilteredRecordListAsync</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name">FilterListCollection</span> filterList<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetFilteredRecordListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>filterList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/lookuplist&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>SortedDictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetLookupListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetLookupListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/distinctlist&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetDistinctListAsync</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name"><span class="token keyword">string</span></span> fieldName<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDistinctListAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/count&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordListCountAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/get&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span></span> <span class="token function">GetRec</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/read&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span></span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/update&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span><span class="token class-name">DbWeatherForecast</span> record<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UpdateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/create&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span><span class="token class-name">DbWeatherForecast</span> record<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MVC<span class="token punctuation">.</span>Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;weatherforecast/delete&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DbTaskResult<span class="token punctuation">&gt;</span></span> <span class="token function">Delete</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name">DbWeatherForecast</span> record<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> DataService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">DeleteRecordAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbWeatherForecast<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="wrap-up"><a href="#wrap-up" class="header-anchor">#</a> Wrap Up</h2> <p>This article demonstrates how to abstract the data and controller tier code into a library and build boilerplate code using generics.</p> <p>Some key points to note:</p> <ol><li>Aysnc code is used wherever possible.  The data access functions are all async.</li> <li>Generics make much of the boilerplating possible.  They create complexity, but are worth the effort.</li> <li>Interfaces are crucial for Dependancy Injection and UI boilerplating.</li></ol> <p>The next section looks at the <a href="https://www.codeproject.com/Articles/5279963/Building-a-Database-Application-in-Blazor-Part-3-C" target="_blank" rel="noopener noreferrer">Presentation Layer / UI Framework<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="history"><a href="#history" class="header-anchor">#</a> History</h2> <ul><li>15-Sep-2020: Initial version.</li> <li>2-Oct-2020: Minor formatting updates and typo fixes.</li> <li>17-Nov-2020: Major Blazor.CEC library changes.  Change to ViewManager from Router and new Component base implementation.</li> <li>7-Feb-2021: Major updates to Services, project structure and data editing.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      
      <a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-1.html" class="prev">
        Part 1 - Project Structure and Framework
      </a></span> <span class="next"><a href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-3.html">
        Part 3 - View Components - CRUD Edit and View Operations in the UI
      </a>
      
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0784ea42.js" defer></script><script src="/assets/js/3.36dc20da.js" defer></script><script src="/assets/js/13.3853eda2.js" defer></script>
  </body>
</html>
